<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a73e8">
    <title>ç‰›è½‰é–€ï¼šæ™‚ç©ºå°èˆªå„€ (çµ‚æ¥µå®Œå…¨ç‰ˆ)</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuWIm+i9iee6gOaZgum6uuiwsOatueitpOakrCIsCiAgInNob3J0X25hbWUiIjogIuWIm+i9iee6gCIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjRmN2Y5IiwKICAidGhlbWVfY29sb3IiOiAiIzFhNzNlOCIKfQ==">

    <style>
        :root {
            --primary: #1a73e8;
            --primary-hover: #1557b0;
            --bg: #f4f7f9;
            --card: #ffffff;
            --up-red: #d32f2f;
            --down-green: #388e3c;
            --warning: #f9ab00;
            --border: #dadce0;
            --text-main: #202124;
            --text-sub: #5f6368;
            --harmony-gold: #ffd700;
            --gate-blue: #0288d1;
            --puzzle-purple: #7b1fa2;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 10px; color: var(--text-main); margin: 0; }

        .container { width: 100%; max-width: 1850px; margin: 0 auto; background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 4px 30px rgba(0,0,0,0.1); }
        
        header { text-align: center; margin-bottom: 10px; border-bottom: 3px solid var(--primary); padding-bottom: 10px; }
        h1 { color: var(--primary); margin: 0; font-size: clamp(1.2rem, 4vw, 1.8rem); }
        .description { color: var(--text-sub); font-size: 0.85rem; margin-top: 5px; font-weight: 500; }

        /* æŠ€è¡“æ ¸å¿ƒå°è®€å€ */
        .core-concept-card {
            background: #f8fbff; border: 1px solid #d1e3ff; border-radius: 10px; padding: 15px; margin: 15px 0 20px 0;
            box-shadow: inset 0 0 10px rgba(26, 115, 232, 0.05);
        }
        .core-concept-card h3 { margin: 0 0 10px 0; font-size: 1rem; color: var(--primary); text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .concept-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .concept-item { font-size: 0.85rem; line-height: 1.5; color: #444; }
        .concept-item b { color: var(--text-main); border-bottom: 2px solid #ddd; }

        /* å„€è¡¨æ¿ */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .meter-card { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 12px; text-align: center; display: flex; flex-direction: column; justify-content: center; min-height: 120px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .meter-title { font-size: 0.8rem; font-weight: bold; color: var(--text-sub); margin-bottom: 6px; border-bottom: 1px solid #f1f3f4; padding-bottom: 4px; }
        .meter-value { font-size: 0.9rem; font-weight: 900; line-height: 1.4; }
        .trend-up { color: var(--up-red); }
        .trend-down { color: var(--down-green); }

        /* æ¥µç«¯è¡Œæƒ…è­¦ç¤ºå€ */
        .alert-panel { display: none; background: #fff; border: 2px solid #ff0000; border-radius: 10px; padding: 15px; margin-bottom: 20px; box-shadow: 0 0 15px rgba(255, 0, 0, 0.1); }
        .alert-title { font-weight: 900; font-size: 1.1rem; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .alert-body { font-size: 0.9rem; line-height: 1.7; color: #333; }
        .alert-status { display: inline-block; padding: 2px 8px; border-radius: 4px; background: #eee; font-weight: bold; margin-top: 5px; }

        /* é…ç½®é¢æ¿ */
        .config-panel { background: #ffffff; padding: 12px; border-radius: 10px; margin-bottom: 20px; border: 1px solid var(--border); }
        .level-row { display: grid; grid-template-columns: 50px 1fr 1fr 1fr 1fr; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f3f4; }
        .level-label { font-weight: 800; font-size: 13px; color: var(--primary); text-align: center; }
        .input-item { display: flex; flex-direction: column; }
        .input-item label { font-size: 10px; color: #777; margin-bottom: 2px; text-align: center; font-weight: bold; }
        select, input { padding: 6px; border-radius: 6px; border: 1px solid var(--border); font-size: 12px; text-align: center; background: #fdfdfd; width: 100%; cursor: pointer; }

        /* æŒ‰éˆ•å€ */
        .actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap; align-items: flex-end; }
        .btn { padding: 10px 25px; border-radius: 25px; font-weight: bold; cursor: pointer; border: none; font-size: 13px; background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(26,115,232,0.3); transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: white; color: var(--primary); border: 1px solid var(--primary); }
        .btn-success { background: var(--down-green); box-shadow: 0 4px 10px rgba(56, 142, 60, 0.3); }

        /* åˆ†é ç³»çµ± */
        .tab-container { margin-top: 25px; }
        .tab-buttons { display: flex; gap: 5px; border-bottom: 2px solid var(--border); margin-bottom: 15px; }
        .tab-btn { padding: 12px 24px; border: none; background: #eee; border-radius: 12px 12px 0 0; cursor: pointer; font-weight: 900; color: var(--text-sub); transition: 0.3s; font-size: 0.9rem; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 -2px 10px rgba(26, 115, 232, 0.2); }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* å•†å“åˆ†æå¡ç‰‡æ¨£å¼ */
        .report-section { display: grid; grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); gap: 20px; padding-bottom: 30px; }
        .report-card { 
            background: #fff; border: 1px solid var(--border); border-radius: 16px; padding: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.07); position: relative; border-top: 6px solid var(--primary); 
        }
        .report-card .close-btn { position: absolute; top: 12px; right: 12px; cursor: pointer; color: #bbb; font-size: 22px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #f8f8f8; }
        .report-card .close-btn:hover { background: #fee; color: #f00; }
        .report-card h4 { margin: 0 0 5px 0; color: var(--primary); font-size: 1.3rem; font-weight: 900; }
        .report-card .timestamp { font-size: 0.75rem; color: #aaa; margin-bottom: 15px; display: block; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .report-card .info-block { font-size: 0.85rem; margin-bottom: 12px; line-height: 1.6; }
        .report-card .info-title { font-weight: 900; color: #333; margin-right: 6px; background: #f2f2f2; padding: 2px 8px; border-radius: 4px; display: inline-block; margin-bottom: 4px; }
        
        .report-card .linkage-box { background: #f8faff; border: 1px solid #e1e9f5; border-radius: 10px; padding: 12px; margin-bottom: 15px; font-size: 0.75rem; }
        .report-card .summary-box { background: #fdfdfd; padding: 14px; border-radius: 12px; border: 1px solid #f0f0f0; margin-bottom: 15px; }
        .report-card .summary-item { margin-bottom: 8px; border-bottom: 1px dashed #e5e5e5; padding-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .report-card .summary-item:last-child { border-bottom: none; margin-bottom: 0; }

        .report-card .master-legend, .footer-notes { background: #fffdf5; border: 1px solid #ffecb3; border-radius: 10px; padding: 15px; font-size: 0.75rem; line-height: 1.6; color: #5d4037; }
        .legend-sec { margin-bottom: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 10px; }
        .legend-sec:last-child { border-bottom: none; margin-bottom: 0; }
        .legend-title { font-weight: 900; color: #795548; display: block; margin-bottom: 6px; font-size: 0.85rem; }

        .report-footer-disclaimer, .app-attribution { margin-top: 15px; font-size: 0.7rem; color: #999; line-height: 1.6; border-top: 1px solid #eee; padding-top: 10px; text-align: center; }
        .report-actions { display: flex; gap: 8px; margin-top: 15px; }

        /* è¡¨æ ¼æ¨£å¼ */
        .result-box { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: #fff; margin-bottom: 15px; }
        .scroll-area { max-height: 55vh; overflow: auto; position: relative; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 11px; min-width: 1400px; }
        thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 20; padding: 12px 4px; border-bottom: 2px solid var(--primary); font-weight: 800; }
        td:first-child, th:first-child { position: sticky; left: 0; background: #f8f9fa; z-index: 10; border-right: 2px solid var(--border); font-weight: 800; }
        td { padding: 10px 4px; text-align: center; border-bottom: 1px solid #f1f3f4; }
        
        .tag-cell { font-weight: 800; border-radius: 4px; padding: 4px 8px; display: inline-block; min-width: 28px; }
        .tag-up { color: #b71c1c; background: #ffebee; border: 1px solid #ef9a9a; } 
        .tag-down { color: #1b5e20; background: #e8f5e9; border: 1px solid #a5d6a7; }

        /* é…è‰²æ¨™ç±¤ */
        .red-text { color: #ff0000; font-weight: bold; }
        .green-text { color: var(--down-green); font-weight: bold; }
        .blue-text { color: var(--primary); font-weight: bold; }

        .skool-link { color: var(--primary); text-decoration: underline; font-weight: bold; }

        /* åˆ—å°å°ˆç”¨æ¨£å¼ */
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; width: 100%; max-width: 100%; margin: 0; padding: 0; }
            header, .core-concept-card, .dashboard, .config-panel, .actions, .tab-buttons, .app-attribution, .close-btn, .report-actions { display: none !important; }
            .tab-content { display: none !important; }
            #contentReport { display: block !important; }
            .tab-content.active { display: block !important; }
            .report-card { border: 2px solid #000; break-inside: avoid; margin-bottom: 20px; box-shadow: none; width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ç‰›è½‰é–€ï¼šæ³¢å‹•ãƒ»æ™‚ç©ºå°èˆªå„€</h1>
        <div class="description">ä¸‰å±¤ç´šè¯å‹•ç›£æ¸¬ | é–€æ§è½‰æ…‹åµæ¸¬ | å°ˆæ¥­å ±å‘Šç³»çµ±</div>
    </header>

    <!-- æŠ€è¡“æ ¸å¿ƒå°è®€å€ -->
    <div class="core-concept-card">
        <h3>ğŸ”‘ ç‰›è»é–‹é–€æŠ€è¡“æ ¸å¿ƒï¼š7å­—è¨£ãƒ»é–€ãƒ»æ³¢å‹•</h3>
        <div class="concept-grid">
            <div class="concept-item"><b>ğŸŒŠ è­˜æ³¢å‹•</b>ï¼šè­˜åˆ¥ 123 (èµ·æ¼²ã€å›æ¸¬ã€ç™¼å‹•) èˆ‡ ABC (èµ·è·Œã€åå½ˆã€ä¸‹æ®º)ã€‚æ³¢å‹•ä¸æ˜¯å‘ä¸Šå°±æ˜¯å‘ä¸‹ã€‚</div>
            <div class="concept-item"><b>ğŸ”¢ 7å­—è¨£</b>ï¼š<b>ã€Œè¦‹ç´…ä¹‹å¾Œç­‰è¦‹é»‘ï¼Œè¦‹é»‘ä¹‹å¾Œç­‰è¦‹ç´…ã€</b>ã€‚åˆ¤å®šå¤šé€±æœŸåˆåŠ›æ–¹å‘ã€‚</div>
            <div class="concept-item"><b>ğŸšª å®šé–€æ§</b>ï¼šç‰©ç†é‚Šç•Œã€‚<b>é–‹é–€çœ‹å¤šï¼Œé—œé–€çœ‹ç©º</b>ã€‚é–€ä¸‹ä¸åšå¤šï¼Œé–€ä¸Šä¸åšç©ºã€‚</div>
        </div>
    </div>

    <!-- æ¥µç«¯è¡Œæƒ…è½‰æŠ˜è­¦ç¤ºå€ -->
    <div id="extremeAlert" class="alert-panel">
        <div id="alertTitle" class="alert-title"></div>
        <div id="alertBody" class="alert-body"></div>
        <div id="alertCounter" class="alert-status"></div>
    </div>

    <div class="dashboard">
        <div class="meter-card">
            <div class="meter-title">ç•¶å‰å¤šç©ºç¸½çµèˆ‡è­¦èª</div>
            <div id="trendMeter" class="meter-value">ç­‰å¾…æ¨æ¼”...</div>
        </div>
        <div class="meter-card">
            <div class="meter-title">æœªä¾†æ¼”åŒ–é è¨€ (æ³¢å‹•ç‰½é€£çµæœ)</div>
            <div id="scenarioText" style="font-size: 0.85rem; font-weight: 600; color: #444;">è«‹è¼¸å…¥åƒæ•¸å¾Œé»æ“Šæ¨æ¼”</div>
        </div>
        <div class="meter-card">
            <div class="meter-title">çµ•å°é˜²ç¦¦è¯å‹• (Risk Control)</div>
            <div id="defensePoint" class="meter-value" style="color: #333; font-size: 0.8rem; text-align: left; padding-left: 10px;">è«‹é»æ“Šæ¨æ¼”é¡¯ç¤ºä¸‰å±¤ç´šç‹€æ…‹</div>
        </div>
    </div>

    <div class="config-panel" id="inputPanel"></div>

    <div class="actions">
        <div class="input-item" style="min-width:150px;">
            <label>å•†å“åç¨±</label>
            <input type="text" id="productName" placeholder="ä¾‹å¦‚ï¼šBTC/USDT" value="">
        </div>
        <button class="btn btn-outline" onclick="loadExample()">è¼‰å…¥ç¯„ä¾‹ (333A3CC1)</button>
        <div class="input-item" style="min-width:160px;">
            <label>å°èˆªåŸºæº–å±¤ç´š</label>
            <select id="refLevel">
                <option value="0">æœˆç·šåŸºæº–</option><option value="1">é€±ç·šåŸºæº–</option><option value="2">æ—¥ç·šåŸºæº–</option>
                <option value="3" selected>4H åŸºæº–</option>
                <option value="4">60m åŸºæº–</option><option value="5">15m åŸºæº–</option>
                <option value="6">5m åŸºæº–</option><option value="7">1m åŸºæº–</option>
            </select>
        </div>
        <div class="input-item" style="min-width:80px;">
            <label>é æ¼”æ­¥æ•¸</label>
            <input type="number" id="stepCount" value="60" min="1">
        </div>
        <button class="btn" onclick="runSystemAnalysis()">åŸ·è¡ŒçŸ©é™£æ¨æ¼”</button>
        <button class="btn btn-success" onclick="generateReportCard()">ç”¢å‡ºåˆ†æå¡ç‰‡</button>
    </div>

    <!-- åˆ†é å°è¦½å€ -->
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-btn active" id="tabBtnTable" onclick="switchTab('table')">ğŸ“Š æ•¸æ“šæ¨æ¼”è¡¨</button>
            <button class="tab-btn" id="tabBtnReport" onclick="switchTab('report')">ğŸ“‡ å•†å“åˆ†æå¡ (<span id="reportCount">0</span>)</button>
        </div>

        <div id="contentTable" class="tab-content active">
            <div class="result-box">
                <div class="scroll-area">
                    <table id="mainTable">
                        <thead>
                            <tr>
                                <th style="width: 85px;">æ­¥æ•¸ / çª—å£</th>
                                <th>æœˆ</th><th>é€±</th><th>æ—¥</th><th>4H</th><th>60m</th><th>15m</th><th>5m</th><th>1m</th>
                                <th style="width: 190px;">èƒ½é‡ãƒ»ç‹€æ…‹ / é–€æ§</th>
                                <th style="min-width:400px;">ç‰›è½‰é–€å¯¦æˆ°è§£æ (æ”¶ç›¤ç¢ºèªç‚ºæº–)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- æ”¾åœ¨æ•¸æ“šæ¨æ¼”è¡¨åˆ†é çš„ç²¾è¯å…§å®¹ -->
            <div class="footer-notes">
                <div class="concept-grid">
                    <div class="legend-sec">
                        <span class="legend-title">âš¡ èƒ½é‡ç­‰ç´šèªªæ˜</span>
                        1. <b>æ¥µå¤š</b>ï¼šå…¨é€±æœŸå‘ä¸Šå…±æŒ¯ï¼Œèƒ½é‡çˆ†ç™¼ã€‚<br>
                        2. <b>å¼·å¤š</b>ï¼šæ­£å¼¦ç›¸ä½ (1, 3, B) ä¸»å°ï¼Œå›æ¸¬è²·é»ã€‚<br>
                        3. <b>å¤šç©ºé—œéµ</b>ï¼šè‡¨ç•Œé»ï¼Œè§€å¯Ÿå°é½’è¼ªå¼•å‹•ã€‚<br>
                        4. <b>ç©ºèª˜å¤š</b>ï¼šBæ®µåå½ˆï¼Œå±¬æ–¼é¤˜å¼¦ä¿®æ­£ï¼Œæº–å‚™æ”¾ç©ºã€‚<br>
                        5. <b>ç©ºé ­</b>ï¼šé¤˜å¼¦ç›¸ä½ (2, A, C) ä¸»å°ï¼Œé‡åŠ›åŠ é€Ÿã€‚
                    </div>
                    <div class="legend-sec">
                        <span class="legend-title">ğŸšª é–€æ§æ©Ÿç†èªªæ˜</span>
                        ğŸ”“ <b>é–‹é–€ç™¼å‹•</b>ï¼šåƒ¹æ ¼ç«™ä¸Š W é–€æˆ–è·Œç ´ M é–€ï¼Œç©ºé–“é–‹å•Ÿã€‚<br>
                        ğŸ”„ <b>æ¸¬é–€è²·é»</b>ï¼šæ¨™ç±¤ 2 å›æ¸¬ä¸ç ´é–€ï¼Œæ˜¯ç‰›è½‰é–€æœ€ç²¾ç¢ºè²·é»ã€‚<br>
                        âš ï¸ <b>Båå½ˆæ‰¾ç©ºé»</b>ï¼šB æ®µåå½ˆå—é˜»æ–¼é–€ï¼Œæ˜¯èª˜å¤šæ‰¾ç©ºæ©Ÿæœƒã€‚<br>
                        ğŸ”’ <b>é—œé–€æ’¤é€€</b>ï¼šåƒ¹æ ¼ç¸®å›é–€å…§ï¼Œä»£è¡¨æ³¢å‹•çµæŸï¼Œæ‡‰ç«‹å³é›¢å ´ã€‚
                    </div>
                    <div class="legend-sec">
                        <span class="legend-title">ğŸ·ï¸ æ¨™ç±¤å±¬æ€§ (ç´…æ¼²ç¶ è·Œ)</span>
                        1, 3, Bï¼šæ­£å¼¦ç›¸ä½ã€‚ä»£è¡¨å‘ä¸Šç™¼æ•£ã€å›å‡æˆ–åå½ˆèƒ½é‡ã€‚<br>
                        2, A, Cï¼šé¤˜å¼¦ç›¸ä½ã€‚ä»£è¡¨å‘ä¸‹ä¿®æ­£ã€åˆè·Œæˆ–ä¸»è·Œé‡åŠ›ã€‚<br>
                        <b>æ”¶ç›¤ç¢ºèªï¼šæ‰€æœ‰åˆ¤æ–·å¿…é ˆä»¥è©²æ™‚æ¡†æ”¶ç›¤åƒ¹ç‚ºæº–ã€‚</b>
                    </div>
                    <div class="legend-sec">
                        <span class="legend-title">ğŸ“ˆ å°èˆªå±¤ç´šå®šä½</span>
                        <b>æœˆ/é€±/æ—¥</b>ï¼šå®è§€é‡åŠ›ï¼Œå®šç¾©æ™‚ä»£ä¹‹é–€ã€‚<br>
                        <b>4H/60m</b>ï¼šæ³¢æ®µæ¨™ç«¿ï¼Œåˆ¤å®šç•¶æ—¥å¼·å¼±ã€‚<br>
                        <b>15m/5m/1m</b>ï¼šé€²å ´æ¿æ©Ÿï¼Œæ•æ‰å¼•å‹•ç¬é–“ã€‚
                    </div>
                </div>
            </div>
        </div>

        <div id="contentReport" class="tab-content">
            <div id="reportGallery" class="report-section"></div>
            <div id="emptyHint" style="text-align:center; padding:60px; color:#999; font-size:0.9rem;">
                å°šæœªç”¢å‡ºå ±å‘Šã€‚è«‹å…ˆé»æ“Šã€Œç”¢å‡ºåˆ†æå¡ç‰‡ã€ã€‚
            </div>
        </div>
    </div>

    <div class="app-attribution">
        ç¨‹å¼æ’°å¯«ï¼šå…­ç”²è±†å­<br>
        âš ï¸ æ³¨æ„ï¼šå€‹äººäº¤æ˜“å¿ƒå¾—æ•´ç†ï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ï¼›æ•™å­¸è«‹è‡³ <a href="https://www.skool.com/niujun-open-the-door/about?ref=35d3add8e5c64bb58850c92c283d1ba4" target="_blank" class="skool-link">SKOOL æŠ€è¡“åŸå‰µè€…</a> å­¸ç¿’
    </div>
</div>

<script>
    const timeframes = [
        { id: 'M', name: 'æœˆ', weight: 25, ratio: 43200 },
        { id: 'W', name: 'é€±', weight: 18, ratio: 10080 },
        { id: 'D', name: 'æ—¥', weight: 14, ratio: 1440 },
        { id: '4H', name: '4H', weight: 12, ratio: 240 },
        { id: '60m', name: '60m', weight: 10, ratio: 60 },
        { id: '15m', name: '15m', weight: 8, ratio: 15 },
        { id: '5m', name: '5m', weight: 8, ratio: 5 },
        { id: '1m', name: '1m', weight: 5, ratio: 1 }
    ];

    const labels = ['1', '2', '3', 'A', 'B', 'C'];
    const labelMap = {'1':0, '2':1, '3':2, 'A':3, 'B':4, 'C':5};

    function initUI() {
        const panel = document.getElementById('inputPanel');
        panel.innerHTML = ''; 
        timeframes.forEach(tf => {
            const row = document.createElement('div');
            row.className = 'level-row';
            row.innerHTML = `
                <div class="level-label">${tf.name}</div>
                <div class="input-item"><label>æ³¢å‹•æ¨™ç±¤</label><select id="wave_${tf.id}"><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></div>
                <div class="input-item"><label>7å­—è¨£æ–¹å‘</label><select id="mantra_${tf.id}"><option value="UP">UP</option><option value="DOWN">DOWN</option></select></div>
                <div class="input-item"><label>é–€å±¬æ€§</label><select id="gateType_${tf.id}"><option value="NONE">ç„¡é–€</option><option value="W_GATE">W é–€</option><option value="M_GATE">M é–€</option></select></div>
                <div class="input-item"><label>é–€é–‹é—œ</label><select id="gateStatus_${tf.id}"><option value="FORMING">å½¢æˆä¸­</option><option value="OPEN">å·²é–‹å•Ÿ</option><option value="CLOSED">å·²é—œé–‰</option></select></div>
            `;
            panel.appendChild(row);
        });
    }

    function switchTab(tab) {
        document.getElementById('contentTable').classList.toggle('active', tab === 'table');
        document.getElementById('tabBtnTable').classList.toggle('active', tab === 'table');
        document.getElementById('contentReport').classList.toggle('active', tab === 'report');
        document.getElementById('tabBtnReport').classList.toggle('active', tab === 'report');
    }

    function loadExample() {
        const ex = ['3','3','3','A','3','C','C','1'];
        timeframes.forEach((tf, i) => document.getElementById(`wave_${tf.id}`).value = ex[i]);
        runSystemAnalysis();
    }

    function getGateStatusHtml(m) {
        if (!m) return "-";
        const typeTxt = m.gateType === 'W_GATE' ? 'Wé–€' : (m.gateType === 'M_GATE' ? 'Mé–€' : 'ç„¡é–€');
        const statusTxt = m.gateStatus === 'OPEN' ? '<span class="red-text">å·²é–‹</span>' : (m.gateStatus === 'CLOSED' ? '<span class="green-text">å·²é—œ</span>' : 'å½¢æˆä¸­');
        return `<b>${m.name}ç´š</b>: ${typeTxt}(${statusTxt})`;
    }

    function getPowerLevel(p) {
        if (p >= 85) return {id:1, name:"1. æ¥µå¤š"};
        if (p >= 70) return {id:2, name:"2. å¼·å¤š"};
        if (p >= 50) return {id:3, name:"3. å¤šç©ºé—œéµ"};
        if (p >= 30) return {id:4, name:"4. ç©ºèª˜å¤š"};
        return {id:5, name:"5. ç©ºé ­"};
    }

    function getGateStatus(tagIdx) {
        if (tagIdx === 0 || tagIdx === 2) return {txt:"ğŸ”“ é–‹é–€ç™¼å‹•", cls:"gs-open"};
        if (tagIdx === 1) return {txt:"ğŸ”„ æ¸¬é–€è²·é»", cls:"gs-open"};
        if (tagIdx === 4) return {txt:"âš ï¸ Båå½ˆæ‰¾ç©ºé»", cls:"gs-alert"};
        return {txt:"ğŸ”’ é—œé–€æ’¤é€€", cls:"gs-close"};
    }

    function runSystemAnalysis() {
        const steps = parseInt(document.getElementById('stepCount').value) || 60;
        const refIdx = parseInt(document.getElementById('refLevel').value);
        const tbody = document.querySelector('#mainTable tbody');
        tbody.innerHTML = '';

        let matrix = timeframes.map(tf => ({
            id: tf.id, name: tf.name, ratio: tf.ratio, weight: tf.weight,
            wave: document.getElementById(`wave_${tf.id}`).value,
            mantra: document.getElementById(`mantra_${tf.id}`).value, 
            gateType: document.getElementById(`gateType_${tf.id}`).value, 
            gateStatus: document.getElementById(`gateStatus_${tf.id}`).value
        }));

        let currentVector = 0;
        matrix.forEach(m => {
            let v = [0, 2, 4].includes(labelMap[m.wave]) ? 1 : -1;
            if (m.mantra === 'DOWN') v -= 0.5;
            if (m.gateStatus === 'CLOSED') v -= 1; 
            if (m.gateStatus === 'OPEN') v += 1; 
            currentVector += v * (m.weight / 10);
        });

        const trendMeter = document.getElementById('trendMeter');
        if (currentVector > 5) { trendMeter.innerHTML = "å¤šç©ºç¸½çµï¼šå‘ä¸Šè¶¨å‹¢ ğŸš€<br><small>é–‹é–€åŠ›ä¸»å°ï¼Œ123 èµ·æ¼²å‹•èƒ½</small>"; trendMeter.className = "meter-card trend-up"; }
        else if (currentVector < -5) { trendMeter.innerHTML = "å¤šç©ºç¸½çµï¼šå‘ä¸‹è¶¨å‹¢ ğŸ“‰<br><small>é—œé–€åŠ›ä¸»å°ï¼ŒABC ä¸‹æ®ºè¶¨å‹¢</small>"; trendMeter.className = "meter-card trend-down"; }
        else { trendMeter.innerHTML = "å¤šç©ºç¸½çµï¼šä¸­æ€§æ•´ç† âš–ï¸<br><small>éœå¾…é–‹é—œé–€ä¿¡è™Ÿ</small>"; trendMeter.className = "meter-card"; }

        updateExtremeAlert(matrix);

        const defensePoint = document.getElementById('defensePoint');
        let macroIdx = refIdx >= 2 ? (refIdx === 4 ? 2 : refIdx - 1) : null;
        let microIdx = refIdx < 7 ? refIdx + 1 : null;
        defensePoint.innerHTML = `${macroIdx !== null ? 'ğŸ”¼ å®è§€ï¼š' + getGateStatusHtml(matrix[macroIdx]) + '<br>' : ''}ğŸ¯ åŸºæº–ï¼š${getGateStatusHtml(matrix[refIdx])}${microIdx !== null ? '<br>ğŸ”½ å¾®è§€ï¼š' + getGateStatusHtml(matrix[microIdx]) : ''}`;

        const scenarioText = document.getElementById('scenarioText');
        if (currentVector > 10) scenarioText.innerHTML = "ğŸš€ <span class='red-text'>å¼·å‹¢ç™¼å‹•</span>ï¼šé–‹é–€åŠ›å¼•å‹•å„å±¤ç´šæ­£å¼¦å…±æŒ¯ã€‚";
        else if (matrix[7].gateStatus === 'OPEN' && currentVector < 0) scenarioText.innerHTML = "âš™ï¸ <span class='blue-text'>å¾®è§€å¼•å‹•</span>ï¼š1m/5m æ­£å˜—è©¦æ‰­è½‰é‡åŠ›ã€‚";
        else scenarioText.innerHTML = "âš–ï¸ ç‰½é€£æ•´ç†ï¼šç›®å‰å„å±¤ç´šæ³¢å‹•å½¼æ­¤ç‰½é€£ä¸­ã€‚";

        for (let s = 1; s <= steps; s++) {
            let rowTags = []; let totalPower = 0;
            matrix.forEach(m => {
                let curIdx = (labelMap[m.wave] + Math.floor(s / m.ratio)) % 6;
                rowTags.push(curIdx);
                if ([0, 2, 4].includes(curIdx)) totalPower += m.weight;
            });

            // å¯¦æˆ°è§£æé‚è¼¯
            let analysis = "";
            const currentRefTag = rowTags[refIdx];
            const refTf = matrix[refIdx];

            if (totalPower >= 85) analysis = "ğŸ”¥ <b>æ¥µå¼·ç™¼å‹•</b>ï¼šé–‹é–€åŠ›å¦‚7å­—è¨£å‘ä¸ŠåŠ ç¸½ï¼Œ123 å‹•èƒ½é–‹å§‹ã€‚";
            else if (totalPower <= 15) analysis = "ğŸ“‰ <b>é‡åŠ›ä¸»å°</b>ï¼šé—œé–€åŠ›å¦‚7å­—è¨£å‘ä¸‹æ•´é«”ï¼Œå•Ÿå‹• ABC ä¸‹æ®ºã€‚";
            else if (currentRefTag === 1) analysis = `ğŸ”„ <b>æ¸¬é–€è²·é»</b>ï¼š${refTf.name}ç´šæ¨™ç±¤ 2 å›æ¸¬ä¸­è»Œï¼Œæ”¶ç›¤ä¸ç ´å³è²·ã€‚`;
            else if (currentRefTag === 4) analysis = `âš ï¸ <b>Bé»æˆªæ“Š</b>ï¼š${refTf.name}ç´šåå½ˆå—å£“æ–¼é–€ï¼Œæº–å‚™æ‰¾é»æ”¾ç©ºã€‚`;
            else if (rowTags[7] === 0 || rowTags[7] === 2) analysis = "âš™ï¸ <b>å¾®è§€å¼•å‹•</b>ï¼š1m å°é½’è¼ªå•Ÿå‹•ï¼Œè©¦åœ–å¸¶å‹•æ›´é«˜å±¤ç´š 123ã€‚";
            else if (rowTags[7] === 3 || rowTags[7] === 5) analysis = "âš ï¸ <b>å¾®è§€é—œé–€</b>ï¼š1m å°é½’è¼ªå¤±æ•ˆï¼Œå°å¿ƒå¸¶å‹•æ›´é«˜å±¤ç´š ABCã€‚";
            else analysis = `â¡ ${refTf.name}ç´šåˆ¥ç©©å®šæ¼”é€²ï¼ŒæŒçºŒç›£æ§é–€æ§ç‰©ç†é‚Šç•Œã€‚`;

            const tr = document.createElement('tr');
            let html = `<td><b>Step ${s}</b></td>`;
            rowTags.forEach(v => { html += `<td><span class="tag-cell ${[0, 2, 4].includes(v) ? 'tag-up' : 'tag-down'}">${labels[v]}</span></td>`; });
            let pLevel = getPowerLevel(totalPower);
            let gStatus = getGateStatus(currentRefTag);
            html += `<td><span class="gate-status-tag ${gStatus.cls}">${gStatus.txt}</span><span class="level-badge p-${pLevel.id}">${pLevel.name}</span><div style="font-size:9px;color:#777">å…±æŒ¯: ${totalPower}%</div></td><td class="analysis-col">${analysis}</td>`;
            tr.innerHTML = html; tbody.appendChild(tr);
        }
    }

    function updateExtremeAlert(matrix) {
        const panel = document.getElementById('extremeAlert');
        const isAll3 = matrix.slice(0, 5).every(m => m.wave === '3');
        const isAllC = matrix.slice(0, 5).every(m => m.wave === 'C');
        if (isAll3) {
            panel.style.display = 'block'; panel.style.borderColor = '#f00';
            document.getElementById('alertTitle').innerHTML = `<span class="red-text">âš ï¸ æ¥µé™½åè½‰è­¦å‘Šï¼š33333 çµæ§‹</span>`;
            document.getElementById('alertBody').innerHTML = `å¤§é€±æœŸæ¥µç››ã€‚é—œé–€åŠ›å³å°‡çˆ†ç™¼ã€‚`;
            let closedCount = 0; [5,6,7].forEach(i => { if (matrix[i].gateStatus === 'CLOSED') closedCount++; });
            document.getElementById('alertCounter').innerHTML = `å¾®è§€é–€é—œé–‰æ•¸ï¼š${closedCount}`;
        } else if (isAllC) {
            panel.style.display = 'block'; panel.style.borderColor = '#388e3c';
            document.getElementById('alertTitle').innerHTML = `<span class="green-text">ğŸš€ æ¥µé™°è½‰å¤šæç¤ºï¼šCCCCC çµæ§‹</span>`;
            document.getElementById('alertBody').innerHTML = `å°‹æ‰¾ 15M ä»¥ä¸‹é–‹é–€å¸¶å‹• 123 çš„ç¬é–“ã€‚`;
            let openCount = 0; [5,6,7].forEach(i => { if (matrix[i].gateStatus === 'OPEN') openCount++; });
            document.getElementById('alertCounter').innerHTML = `å¾®è§€é–€é–‹å•Ÿæ•¸ï¼š${openCount}`;
        } else panel.style.display = 'none';
    }

    function generateReportCard() {
        const prod = document.getElementById('productName').value || "æœªå‘½åå•†å“";
        const time = new Date().toLocaleString();
        const trend = document.getElementById('trendMeter').innerHTML;
        const scenario = document.getElementById('scenarioText').innerHTML;
        const refIdx = document.getElementById('refLevel').selectedIndex;
        const refName = document.getElementById('refLevel').options[refIdx].text;
        
        let matrix = timeframes.map(tf => ({
            id: tf.id, name: tf.name, wave: document.getElementById(`wave_${tf.id}`).value,
            gateType: document.getElementById(`gateType_${tf.id}`).value,
            gateStatus: document.getElementById(`gateStatus_${tf.id}`).value,
            mantra: document.getElementById(`mantra_${tf.id}`).value
        }));

        const macroInfo = [0, 1, 2].map(i => getGateStatusHtml(matrix[i])).join('<br>');
        const trendInfo = [4, 5, 6].map(i => getGateStatusHtml(matrix[i])).join('<br>');

        let summaryList = "";
        timeframes.forEach(tf => {
            const wave = document.getElementById(`wave_${tf.id}`).value;
            const tagIdx = labelMap[wave];
            const gStatus = getGateStatus(tagIdx);
            const isUp = [0, 2, 4].includes(tagIdx);
            const pLevel = getPowerLevel(isUp ? 75 : 25); 
            summaryList += `<div class="summary-item"><b class="blue-text">${tf.name}:</b><span style="font-size:0.75rem;">${gStatus.txt} | ${pLevel.name}</span></div>`;
        });

        const card = document.createElement('div');
        card.className = 'report-card';
        card.innerHTML = `
            <span class="close-btn" onclick="this.parentElement.remove(); updateBadge();">Ã—</span>
            <h4>ğŸ“Š ${prod}</h4>
            <span class="timestamp">åˆ†æç”¢å‡ºæ™‚é–“ï¼š${time}</span>
            <div class="info-block"><span class="info-title">è§€å¯Ÿç´šåˆ¥åŸºæº–:</span><b class="blue-text">${refName}</b></div>
            <div class="info-block"><span class="info-title">å¤šç©ºè¶¨å‹¢ç¸½çµ:</span>${trend}</div>
            <div class="info-block"><span class="info-title">æ³¢å‹•ç‰½é€£é è¨€:</span>${scenario}</div>
            <div class="linkage-box">
                <div style="font-weight:900; margin-bottom:8px; color:#444; border-bottom:1px solid #ddd;">ğŸ›¡ï¸ é›™é¡åˆ¥é˜²ç¦¦è¯å‹•ç¾æ³:</div>
                <div style="margin-bottom:10px;"><b>1. å®è§€ä½éš (æœˆ/é€±/æ—¥):</b><br>${macroInfo}</div>
                <div><b>2. è¶¨å‹¢æ‰³æ©Ÿ (60M/15M/5M):</b><br>${trendInfo}</div>
            </div>
            <div class="summary-box">
                <div style="font-weight:900; margin-bottom:10px; font-size:0.8rem; border-bottom:1px solid #eee; padding-bottom:5px;">ğŸ“ˆ æ­¸ç´å…¨ç´šåˆ¥ç‹€æ…‹:</div>
                ${summaryList}
            </div>
            <div class="master-legend">
                <div class="legend-sec">
                    <span class="legend-title">âš¡ èƒ½é‡ç­‰ç´šèªªæ˜</span>
                    1. æ¥µå¤šï¼šå…¨é€±æœŸå‘ä¸Šå…±æŒ¯ï¼Œèƒ½é‡çˆ†ç™¼ã€‚<br>
                    2. å¼·å¤šï¼šæ­£å¼¦ç›¸ä½ (1, 3, B) ä¸»å°ï¼Œå›æ¸¬è²·é»ã€‚<br>
                    3. å¤šç©ºé—œéµï¼šè‡¨ç•Œé»ï¼Œè§€å¯Ÿå°é½’è¼ªå¼•å‹•ã€‚<br>
                    4. ç©ºèª˜å¤šï¼šBæ®µåå½ˆï¼Œå±¬æ–¼é¤˜å¼¦ä¿®æ­£ï¼Œæº–å‚™æ”¾ç©ºã€‚<br>
                    5. ç©ºé ­ï¼šé¤˜å¼¦ç›¸ä½ (2, A, C) ä¸»å°ï¼Œé‡åŠ›åŠ é€Ÿã€‚
                </div>
                <div class="legend-sec">
                    <span class="legend-title">ğŸšª é–€æ§æ©Ÿç†èªªæ˜</span>
                    ğŸ”“ é–‹é–€ç™¼å‹•ï¼šåƒ¹æ ¼ç«™ä¸Š W é–€æˆ–è·Œç ´ M é–€ï¼Œç©ºé–“é–‹å•Ÿã€‚<br>
                    ğŸ”„ æ¸¬é–€è²·é»ï¼šæ¨™ç±¤ 2 å›æ¸¬ä¸ç ´é–€ï¼Œæ˜¯ç‰›è½‰é–€æœ€ç²¾ç¢ºè²·é»ã€‚<br>
                    âš ï¸ Båå½ˆæ‰¾ç©ºé»ï¼šB æ®µåå½ˆå—é˜»æ–¼é–€ï¼Œæ˜¯èª˜å¤šæ‰¾ç©ºæ©Ÿæœƒã€‚<br>
                    ğŸ”’ é—œé–€æ’¤é€€ï¼šåƒ¹æ ¼ç¸®å›é–€å…§ï¼Œä»£è¡¨æ³¢å‹•çµæŸï¼Œæ‡‰ç«‹å³é›¢å ´ã€‚
                </div>
                <div class="legend-sec">
                    <span class="legend-title">ğŸ·ï¸ æ¨™ç±¤å±¬æ€§ (ç´…æ¼²ç¶ è·Œ)</span>
                    1, 3, Bï¼šæ­£å¼¦ç›¸ä½ã€‚ä»£è¡¨å‘ä¸Šç™¼æ•£ã€å›å‡æˆ–åå½ˆèƒ½é‡ã€‚<br>
                    2, A, Cï¼šé¤˜å¼¦ç›¸ä½ã€‚ä»£è¡¨å‘ä¸‹ä¿®æ­£ã€åˆè·Œæˆ–ä¸»è·Œé‡åŠ›ã€‚<br>
                    <b>æ”¶ç›¤ç¢ºèªï¼šæ‰€æœ‰åˆ¤æ–·å¿…é ˆä»¥è©²æ™‚æ¡†æ”¶ç›¤åƒ¹ç‚ºæº–ã€‚</b>
                </div>
                <div class="legend-sec">
                    <span class="legend-title">ğŸ“ˆ å°èˆªå±¤ç´šå®šä½</span>
                    æœˆ/é€±/æ—¥ï¼šå®è§€é‡åŠ›ï¼Œå®šç¾©æ™‚ä»£ä¹‹é–€ã€‚<br>
                    4H/60mï¼šæ³¢æ®µæ¨™ç«¿ï¼Œåˆ¤å®šç•¶æ—¥å¼·å¼±ã€‚<br>
                    15m/5m/1mï¼šé€²å ´æ¿æ©Ÿï¼Œæ•æ‰å¼•å‹•ç¬é–“ã€‚
                </div>
            </div>
            <div class="report-footer-disclaimer">
                ç¨‹å¼æ’°å¯«ï¼šå…­ç”²è±†å­ | æ•™å­¸è«‹è‡³ <a href="https://www.skool.com/niujun-open-the-door/about?ref=35d3add8e5c64bb58850c92c283d1ba4" target="_blank">SKOOL æŠ€è¡“åŸå‰µè€…</a> å­¸ç¿’
            </div>
            <div class="report-actions">
                <button class="btn btn-outline" style="padding:6px 12px; font-size:11px;" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°åˆ†æå ±å‘Š / å¦å­˜PDF</button>
            </div>
        `;
        document.getElementById('reportGallery').prepend(card);
        document.getElementById('emptyHint').style.display = 'none';
        updateBadge();
        switchTab('report');
    }

    function updateBadge() {
        const count = document.getElementById('reportGallery').children.length;
        document.getElementById('reportCount').innerText = count;
        if (count === 0) document.getElementById('emptyHint').style.display = 'block';
    }

    window.onload = initUI;
</script>

</body>
</html>