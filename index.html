<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1565c0">
    <title>ç‰›è½‰é–€ï¼šæ™‚ç©ºå°èˆªå„€ (çµ‚æ¥µå®Œå…¨ç¾åŒ–ç‰ˆ)</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuWIm+i9iee6gOaZgum6uuiwsOatueitpOakrCIsCiAgInNob3J0X25hbWUiIjogIuWIm+i9iee6gCIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjRmN2Y5IiwKICAidGhlbWVfY29sb3IiOiAiIzFhNzNlOCIKfQ==">

    <!-- å¼•å…¥ html2canvas æ”¯æ´æ‰‹æ©Ÿå„²å­˜åœ–ç‰‡ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #1565c0;
            --primary-light: #e3f2fd;
            --accent: #ff9800;
            --bg: #f0f4f8;
            --card-bg: #ffffff;
            --up-red: #e53935;
            --down-green: #2e7d32;
            --text-dark: #1a237e;
            --text-main: #37474f;
            --text-sub: #78909c;
            --border-color: #cfd8dc;
            --shadow: 0 12px 35px rgba(21, 101, 192, 0.12);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', system-ui, sans-serif; background: var(--bg); padding: 12px; color: var(--text-main); margin: 0; line-height: 1.5; overflow-x: hidden; }

        .container { width: 100%; max-width: 1650px; margin: 0 auto; background: var(--card-bg); padding: clamp(15px, 4vw, 25px); border-radius: clamp(15px, 5vw, 36px); box-shadow: var(--shadow); }
        
        header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #f1f3f4; padding-bottom: 20px; }
        header h1 { color: var(--primary); margin: 0; font-size: clamp(1.4rem, 6vw, 2.8rem); font-weight: 900; letter-spacing: -1.5px; }
        header .description { color: var(--text-sub); font-size: clamp(0.85rem, 2vw, 1rem); margin-top: 8px; font-weight: 700; letter-spacing: 1px; }

        /* æŠ€è¡“æ ¸å¿ƒå°è®€å€ - RWD */
        .core-concept-v4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%, 400px), 1fr)); gap: 20px; margin-bottom: 35px; }
        .concept-card { background: linear-gradient(145deg, #ffffff, #f1f7ff); border: 1px solid #e1f5fe; border-radius: 24px; padding: clamp(15px, 3vw, 25px); display: flex; align-items: flex-start; gap: clamp(10px, 3vw, 20px); box-shadow: 0 6px 18px rgba(0,0,0,0.03); transition: transform 0.3s; }
        .concept-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .concept-card .icon { font-size: clamp(1.8rem, 4vw, 2.5rem); background: var(--primary-light); width: clamp(50px, 8vw, 65px); height: clamp(50px, 8vw, 65px); display: flex; align-items: center; justify-content: center; border-radius: 20px; flex-shrink: 0; }
        .concept-card .title { font-weight: 900; font-size: clamp(1.1rem, 3vw, 1.25rem); color: var(--primary); margin-bottom: 10px; border-bottom: 2px solid #e1f5fe; padding-bottom: 5px; display: block; }
        .concept-card .desc { font-size: clamp(0.8rem, 2.5vw, 0.9rem); color: var(--text-main); margin: 0; font-weight: 500; line-height: 1.8; }

        /* å„€è¡¨æ¿ - RWD */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%, 320px), 1fr)); gap: 20px; margin-bottom: 35px; }
        .meter-card { background: #fff; border: 1.5px solid var(--border-color); border-radius: 24px; padding: clamp(15px, 3vw, 25px); min-height: 140px; display: flex; flex-direction: column; justify-content: center; border-bottom: 8px solid var(--primary); transition: 0.4s; }
        .meter-card.up { border-bottom-color: var(--up-red); }
        .meter-card.down { border-bottom-color: var(--down-green); }
        .meter-title { font-size: 0.9rem; font-weight: 800; color: var(--text-sub); margin-bottom: 15px; text-transform: uppercase; }
        .meter-value { font-size: clamp(0.95rem, 3vw, 1.1rem); font-weight: 900; color: var(--text-dark); line-height: 1.6; }

        /* é…ç½®é¢æ¿è¡¨æ ¼åŒ–èˆ‡ RWD é©æ‡‰ */
        .config-panel { background: #fcfdfe; padding: clamp(15px, 3vw, 25px); border-radius: 28px; border: 2px solid #eceff1; margin-bottom: 35px; }
        .config-grid { width: 100%; }
        .config-header { display: grid; grid-template-columns: 100px 1fr 1fr 1.5fr 1.5fr; gap: 15px; padding-bottom: 18px; border-bottom: 4px solid var(--primary); text-align: center; }
        .config-header span { font-weight: 900; font-size: 14px; color: var(--primary); }
        .level-row { display: grid; grid-template-columns: 100px 1fr 1fr 1.5fr 1.5fr; gap: 15px; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
        .level-label { font-weight: 900; font-size: 18px; color: var(--text-dark); text-align: center; }

        @media (max-width: 1024px) {
            .config-header { display: none; }
            .level-row { grid-template-columns: 1fr 1fr; gap: 10px; border-bottom: 3px solid #eee; padding: 20px 10px; }
            .level-label { grid-column: span 2; font-size: 1.3rem; background: var(--primary-light); color: var(--primary); padding: 8px; border-radius: 12px; margin-bottom: 10px; }
            .input-item { display: flex; flex-direction: column; gap: 5px; }
            .input-item::before { content: attr(data-label); font-size: 11px; font-weight: 900; color: var(--text-sub); text-align: left; padding-left: 5px; }
        }

        /* çµ±ä¸€æ¬„ä½ CSS æ ¼å¼ */
        select, input { 
            width: 100%; height: 48px; padding: 0 14px; border-radius: 15px; border: 2px solid #e2e8f0; font-size: 14px; transition: all 0.2s ease; background: #fff; text-align: center; font-weight: 800; color: #333; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        select:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); outline: none; }
        select:hover, input:hover { border-color: var(--primary); background: #f8fbff; }

        /* æŒ‰éˆ•ç³»çµ± */
        .actions { display: flex; gap: 15px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
        .btn { padding: 16px clamp(20px, 5vw, 40px); border-radius: 20px; font-weight: 900; cursor: pointer; border: none; transition: 0.3s; font-size: 15px; box-shadow: 0 8px 20px rgba(21, 101, 192, 0.15); flex: 1 1 auto; min-width: 150px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--down-green); color: white; }
        .btn-outline { background: white; color: var(--primary); border: 3px solid var(--primary); }

        /* åˆ†é åˆ‡æ› */
        .tab-buttons { display: flex; gap: 10px; border-bottom: 4px solid #eee; margin-bottom: 30px; overflow-x: auto; -ms-overflow-style: none; scrollbar-width: none; }
        .tab-buttons::-webkit-scrollbar { display: none; }
        .tab-btn { padding: 15px 30px; border: none; background: transparent; cursor: pointer; font-weight: 900; color: var(--text-sub); font-size: clamp(1rem, 2.5vw, 1.2rem); position: relative; transition: 0.3s; white-space: nowrap; }
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -4px; left: 0; width: 100%; height: 6px; background: var(--primary); border-radius: 6px; }
        .tab-content { display: none; animation: fadeIn 0.5s ease; }
        .tab-content.active { display: block; }

        /* æ•¸æ“šæ¨æ¼”è¡¨ - RWD æ»¾å‹• */
        .result-box { border: 2px solid var(--border-color); border-radius: 28px; overflow: hidden; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.04); }
        .scroll-area { max-height: 70vh; overflow: auto; width: 100%; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; min-width: 1400px; }
        thead th { position: sticky; top: 0; background: #f8fafc; z-index: 20; padding: 15px 10px; border-bottom: 5px solid var(--primary); font-weight: 900; color: var(--primary); text-align: center; }
        td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .tag-cell { font-weight: 900; border-radius: 12px; padding: 8px 12px; display: inline-block; min-width: 40px; box-shadow: 0 4px 8px rgba(0,0,0,0.12); font-size: 13px; }
        .tag-up { color: #fff; background: var(--up-red); } 
        .tag-down { color: #fff; background: var(--down-green); }

        /* å•†å“åˆ†æå¡ */
        .report-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%, 850px), 1fr)); gap: 30px; }
        .report-card { background: #fff; border-radius: clamp(20px, 5vw, 42px); padding: clamp(20px, 5vw, 60px); border: 2px solid #e2e8f0; box-shadow: 0 35px 100px rgba(0,0,0,0.15); position: relative; border-top: clamp(10px, 3vw, 25px) solid var(--primary); }
        .report-card .part-box { background: #f9fbff; border-radius: 24px; padding: clamp(15px, 4vw, 40px); border: 2px solid #edf2f7; margin-bottom: 30px; }
        .report-card .part-header { font-weight: 900; font-size: clamp(1.2rem, 3vw, 1.8rem); margin-bottom: 25px; color: #1e293b; border-left: 10px solid var(--primary); padding: 10px 20px; background: #eef2ff; border-radius: 0 15px 15px 0; }
        .report-card .summary-item { margin-bottom: 30px; border-bottom: 2px dashed #cbd5e0; padding-bottom: 25px; }
        
        .red-text { color: var(--up-red) !important; font-weight: 800; }
        .green-text { color: var(--down-green) !important; font-weight: 800; }
        .blue-text { color: var(--primary) !important; font-weight: 800; }

        .report-footer-disclaimer { margin-top: 20px; padding: 20px; border-top: 2px solid #f1f3f4; font-size: 0.95rem; line-height: 1.8; color: #64748b; }
        .close-btn { position: absolute; top: clamp(10px, 3vw, 25px); right: clamp(10px, 3vw, 25px); font-size: 35px; color: #cbd5e0; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; border-radius: 0; max-width: 100%; }
            header, .core-concept-v4, .dashboard, .config-panel, .actions, .tab-buttons, .app-attribution, .footer-notes { display: none !important; }
            .tab-content { display: none !important; }
            #contentReport { display: block !important; }
            .report-card { border: 6px solid #000; padding: 40px; break-inside: avoid; border-top: 40px solid #000; box-shadow: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ç‰›è½‰é–€ï¼šæ³¢å‹•ãƒ»æ™‚ç©ºå°èˆªå„€</h1>
        <div class="description">ç‰©ç†ç©ºé–“é æ¼” | é›™è»Œé–€æ§æ€§è³ªåµæ¸¬ | çµ‚æ¥µæˆ°ç•¥ç³»çµ±</div>
    </header>

    <!-- æŠ€è¡“æ ¸å¿ƒå°è®€å€ -->
    <div class="core-concept-v4">
        <div class="concept-card">
            <div class="icon">ğŸŒŠ</div>
            <div class="text-wrap">
                <span class="title">è­˜æ³¢å‹•ï¼ˆ123 / ABCï¼‰</span>
                <div class="desc">
                    - <span class="red-text">å‘ä¸Šè¶¨å‹¢</span>ï¼š1 <span class="red-text">èµ·æ¼²</span> â†’ 2 å›æ¸¬ â†’ 3 <span class="red-text">ç™¼å‹•</span> <br>
                    - <span class="green-text">å‘ä¸‹è¶¨å‹¢</span>ï¼šA <span class="green-text">èµ·è·Œ</span> â†’ B åå½ˆ â†’ C <span class="green-text">ä¸»è·Œ</span> <br>
                    - æ³¢å‹•ä¸æ˜¯<span class="red-text">å‘ä¸Š</span>å°±æ˜¯<span class="green-text">å‘ä¸‹</span>ï¼›ç›®æ¨™æ˜¯è¾¨è­˜ç›¸ä½èˆ‡æ…£æ€§å»¶çºŒã€‚
                </div>
            </div>
        </div>
        <div class="concept-card">
            <div class="icon">ğŸ”¢</div>
            <div class="text-wrap">
                <span class="title">7 å­—è¨£ï¼ˆè¦‹ç´…ç­‰é»‘ï¼Œè¦‹é»‘ç­‰ç´…ï¼‰</span>
                <div class="desc">
                    - <b>å¿ƒæ³•</b>ï¼šã€Œè¦‹ç´…ä¹‹å¾Œç­‰è¦‹é»‘ï¼Œè¦‹é»‘ä¹‹å¾Œç­‰è¦‹ç´…ã€ã€‚ <br>
                    - <b>æ–¹æ³•</b>ï¼šä»¥ K æ£’ / MACD å †è¡¡é‡èƒ½é‡ï¼›åœ¨è¡°ç«­èˆ‡åˆ‡æ›è™•ç­‰å¾…ä¸‹ä¸€æ®µçµæ§‹ã€‚åˆ¤å®šå¤šé€±æœŸåˆåŠ›æ–¹å‘ã€‚
                </div>
            </div>
        </div>
        <div class="concept-card">
            <div class="icon">ğŸšª</div>
            <div class="text-wrap">
                <span class="title">å®šé–€æ§ï¼ˆW / Mï¼‰</span>
                <div class="desc">
                    - é–€æ˜¯åƒ¹æ ¼çš„ç‰©ç†é‚Šç•Œï¼š<span class="red-text">é–‹é–€</span>ï¼æ–°ç©ºé–“è¢«æ‰“é–‹ï¼›<span class="green-text">é—œé–€</span>ï¼åŸè¶¨å‹¢ç©ºé–“è¢«é—œé–‰ã€‚ <br>
                    - <b>è¦å‰‡</b>ï¼š<br>
                    &nbsp;&nbsp;â€¢ æ”¶ç›¤åƒ¹ç«™ä¸Š <b>W é–€</b> â†’ çœ‹å¤šï¼ˆå•Ÿå‹• 123ï¼‰<br>
                    &nbsp;&nbsp;â€¢ æ”¶ç›¤åƒ¹è·Œç ´ <b>M é–€</b> â†’ çœ‹ç©ºï¼ˆå•Ÿå‹• ABCï¼‰<br>
                    &nbsp;&nbsp;â€¢ <span class="red-text">é–€ä¸Šä¸åšç©º</span>ã€<span class="green-text">é–€ä¸‹ä¸åšå¤š</span>ï¼›ä¸€åˆ‡ä»¥ã€Œè©²æ™‚æ¡†æ”¶ç›¤ã€ç¢ºèªæœ‰æ•ˆã€‚
                </div>
            </div>
        </div>
    </div>

    <!-- å„€è¡¨æ¿ -->
    <div class="dashboard">
        <div class="meter-card" id="trendMeterCard">
            <div class="meter-title">ğŸŒ“ ç•¶å‰å…¨é€±æœŸåˆåŠ›è¶¨å‹¢çµè«–</div>
            <div id="trendMeter" class="meter-value">ç­‰å¾…ç‰©ç†çŸ©é™£æ¨æ¼”...</div>
        </div>
        <div class="meter-card">
            <div class="meter-title">ğŸ”® æœªä¾†æ™ºæ…§é è¨€åŠ‡æœ¬ (å¾Œè¨­)</div>
            <div id="scenarioText" style="font-size: 0.95rem; font-weight: 700; color: #444; text-align: left;">è«‹åŸ·è¡ŒçŸ©é™£æ¨æ¼”</div>
        </div>
        <div class="meter-card">
            <div class="meter-title">ğŸ›¡ï¸ é—œéµé€±æœŸé˜²ç¦¦ç¾æ³</div>
            <div id="defensePoint" class="meter-value" style="color: #333; font-size: 0.95rem; text-align: left;">è«‹åŸ·è¡Œæ¨æ¼”</div>
        </div>
    </div>

    <!-- é…ç½®é¢æ¿ -->
    <div class="config-panel">
        <div class="config-grid">
            <div class="config-header">
                <span>åˆ†æé€±æœŸ</span><span>ç•¶ä¸‹æ³¢å‹•</span><span>ç•¶ä¸‹ä¸ƒå­—è¨£</span><span>ç•¶ä¸‹ M é–€ (å¤©)</span><span>ç•¶ä¸‹ W é–€ (åœ°)</span>
            </div>
            <div id="inputPanel"></div>
        </div>
    </div>

    <!-- æ“ä½œå€ -->
    <div class="actions">
        <div class="input-item" style="min-width:260px;" data-label="å•†å“åç¨±æ¨™è­˜">
            <input type="text" id="productName" placeholder="ä¾‹å¦‚ï¼šBTC/USDT">
        </div>
        <button class="btn btn-outline" onclick="loadExample()">è¼‰å…¥ç¯„ä¾‹é‚è¼¯ (333A3CC1)</button>
        <div class="input-item" style="min-width:240px;" data-label="æ ¸å¿ƒè§€å¯ŸåŸºæº–">
            <select id="refLevel">
                <option value="0">æœˆç´šåˆ¥</option><option value="1">é€±ç´šåˆ¥</option><option value="2">æ—¥ç´šåˆ¥</option>
                <option value="3" selected>4Hç´šåˆ¥</option><option value="4">60Mç´šåˆ¥</option><option value="5">15Mç´šåˆ¥</option>
                <option value="6">5Mç´šåˆ¥</option><option value="7">1Mç´šåˆ¥</option>
            </select>
        </div>
        <div class="input-item" style="min-width:140px;" data-label="æœªä¾†é æ¼”æ­¥æ•¸">
            <input type="number" id="stepCount" value="60">
        </div>
        <button class="btn btn-primary" onclick="runSystemAnalysis()">åŸ·è¡Œå¤šé€±æœŸæ¨æ¼”</button>
        <button class="btn btn-success" onclick="generateReportCard()">ç”¢å‡ºå°ˆæ¥­æˆ°ç•¥å¡</button>
    </div>

    <!-- åˆ†é åˆ‡æ› -->
    <div class="tab-buttons">
        <button class="tab-btn active" id="tabBtnTable" onclick="switchTab('table')">ğŸ“Š æ•¸æ“šè·¯å¾‘æ¨æ¼”</button>
        <button class="tab-btn" id="tabBtnReport" onclick="switchTab('report')">ğŸ“‡ æˆ°ç•¥å ±å‘Šå­˜æª” (<span id="reportCount">0</span>)</button>
    </div>

    <!-- æ•¸æ“šè¡¨åˆ†é  -->
    <div id="contentTable" class="tab-content active">
        <div class="result-box">
            <div class="scroll-area">
                <table id="mainTable">
                    <thead>
                        <tr>
                            <th style="width: 130px;">é æ¼”æ­¥æ•¸</th>
                            <th>æœˆ</th><th>é€±</th><th>æ—¥</th><th>4H</th><th>60m</th><th>15m</th><th>5m</th><th>1m</th>
                            <th style="width: 240px;">èƒ½é‡ãƒ»é–€æ§æ€§è³ª</th>
                            <th style="min-width:550px;">ç‰›è½‰é–€å¯¦æˆ°æ·±åº¦è§£æ (æ”¶ç›¤ç‚ºæº–)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å ±å‘Šå­˜æª”åˆ†é  -->
    <div id="contentReport" class="tab-content">
        <div id="reportGallery" class="report-section"></div>
        <div id="emptyHint" style="text-align:center; padding:180px; color:#94a3b8; font-weight:900; font-size:1.5rem;">å°šæœªç”¢å‡ºä»»ä½•æˆ°ç•¥å ±å‘Šã€‚</div>
    </div>

    <div class="app-attribution" style="margin-top:60px; text-align:center; color:#adb5bd; font-size:0.9rem; border-top:1px solid #f1f3f4; padding-top:40px;">
        æ ¸å¿ƒæ¼”ç®—æ³•ï¼šå…­ç”²è±†å­ | ç‰©ç†æ³¢å‹•è«–åŸå‰µï¼šSKOOL ç‰›è»é–‹é–€
    </div>
</div>

<script>
    const timeframes = [
        { id: 'M', name: 'æœˆ', weight: 25, ratio: 43200 },
        { id: 'W', name: 'é€±', weight: 18, ratio: 10080 },
        { id: 'D', name: 'æ—¥', weight: 14, ratio: 1440 },
        { id: '4H', name: '4H', weight: 12, ratio: 240 },
        { id: '60m', name: '60m', weight: 10, ratio: 60 },
        { id: '15m', name: '15m', weight: 8, ratio: 15 },
        { id: '5m', name: '5m', weight: 8, ratio: 5 },
        { id: '1m', name: '1m', weight: 5, ratio: 1 }
    ];
    const labels = ['1', '2', '3', 'A', 'B', 'C'];
    const labelMap = {'1':0, '2':1, '3':2, 'A':3, 'B':4, 'C':5};

    function getPowerLevel(p) {
        if (p >= 85) return {id:1, name:"1. æ¥µå¤š (ç™¼è»Ÿ)"};
        if (p >= 70) return {id:2, name:"2. å¼·å¤š (è¶¨å‹¢)"};
        if (p >= 50) return {id:3, name:"3. å¤šç©ºé—œéµ"};
        return {id:5, name:"5. ç©ºé ­ (å¡Œé™·)"};
    }

    function getGateStatus(tagIdx) {
        const isUp = [0, 2, 4].includes(tagIdx);
        if (tagIdx === 1) return {txt:"ğŸ”„ æ¸¬é–€è²·é»", cls:"red-text"};
        return isUp ? {txt:"ğŸ”“ <span class='red-text'>é–‹é–€ç™¼å‹•</span>", cls:"red-text"} : {txt:"ğŸ”’ <span class='green-text'>é—œé–€æ’¤é€€</span>", cls:"green-text"};
    }

    function getGateStatusHtml(status, type, name) {
        if (!name || status === 'NONE') return "-";
        const statusTxt = status === 'OPEN' ? '<span class="red-text">å·²é–‹</span>' : (status === 'CLOSED' ? '<span class="green-text">å·²é—œ</span>' : 'å½¢æˆä¸­');
        return `<b>${name}ç´š</b>: ${type==='W_GATE'?'Wé–€':'Mé–€'}(${statusTxt})`;
    }

    function getPracticalAnalysis(tagIdx, totalPower, tfName, matrixRow) {
        const isUp = [0, 2, 4].includes(tagIdx);
        const col = isUp ? "red-text" : "green-text";
        if (totalPower >= 85) return `ğŸ”¥ <b class="${col}">æ¥µå¤šå…±æŒ¯ï¼š</b><span class="red-text">é–‹é–€</span>åŠ›å¼·çƒˆåŠ ç¸½ï¼Œå•Ÿå‹•å…¨é€±æœŸ 123 <span class="red-text">å‘ä¸Šç™¼å‹•</span>ã€‚`;
        if (totalPower <= 15) return `ğŸ“‰ <b class="${col}">ç©ºé ­ä¸»å°ï¼š</b><span class="green-text">é—œé–€</span>é‡åŠ›å¼·çƒˆåŠ ç¸½ï¼Œå•Ÿå‹•å…¨é€±æœŸ ABC <span class="green-text">èµ·è·Œä¸‹æ®º</span>ã€‚`;
        if (tagIdx === 1) return `ğŸ”„ <b class="${col}">æ¸¬é–€è²·é»ï¼š</b>${tfName}ç´š 2 å›æ¸¬ï¼Œæ”¶ç›¤å®ˆä½åœ°æ¿å³å¯åƒèˆ‡ <span class="red-text">ç™¼å‹•</span>ã€‚`;
        return `â¡ <b class="${col}">${tfName}ç´šæ€§è³ªæ¼”é€²ï¼š</b>ç›£æ§é–€æ§é‚Šç•Œï¼Œæ”¶ç›¤ç¢ºèªæ€§è³ªã€‚`;
    }

    // --- ç©ºé–“ç‰©ç†çµè«– ---
    function getRangeConclusion(m) {
        const w = m.wGate; const m_ = m.mGate;
        if (w === 'OPEN' && m_ === 'OPEN') return "<span class='red-text'>çªç ´é–€ç•Œå‘ä¸Š ğŸš€</span>";
        if (w === 'CLOSED') return "<span class='green-text'>è·Œç ´é–€ç•Œå‘ä¸‹ ğŸ“‰</span>";
        if (m_ === 'CLOSED') return "<span class='green-text'>å°é ‚å›è½ï¼Œç•Œç·šç¢ºå®š âš–ï¸</span>";
        if (w === 'OPEN' && m_ === 'NONE') return "<span class='red-text'>æ½›åŠ›å‘ä¸Š (åœ°æ’) ğŸ“ˆ</span>";
        if (m_ === 'OPEN' && w === 'NONE') return "<span class='green-text'>æ½›åŠ›å‘ä¸‹ (å¤©é˜») ğŸ“‰</span>";
        return "é–€ç¯„åœå…§éœ‡ç›ªæ€§è³ª";
    }

    function getLevelMetaScript(mInfo, steps) {
        const {name, wave, wGate, mGate, ratio} = mInfo;
        let finalIdx = (labelMap[wave] + Math.floor(steps / ratio)) % 6;
        let finalLabel = labels[finalIdx];
        const isFinalUp = [0, 2, 4].includes(finalIdx);
        const colorClass = isFinalUp ? 'red-text' : 'green-text';
        const conclusion = getRangeConclusion(mInfo);

        const scripts = {
            '1': `ğŸš€ <b class='red-text'>èµ·æ¼²æ€§è³ª (1è½‰2/3)</b>ï¼šmacdæ³¢æ®µå¾ <span class='red-text'>1</span> èµ°å‘ <span class='${colorClass}'>${finalLabel}</span>ï¼Œè§€å¯Ÿ(ä¹‹ä¸Š,è‡ªå·±,ä¹‹ä¸‹)é—œéµé–€åŠå‹•æ…‹ã€‚çµè«–ï¼š${conclusion}`,
            '2': `âš–ï¸ <b class='blue-text'>è½‰åŒ–è‡¨ç•Œ (2è½‰3/A/C)</b>ï¼šå›æ¸¬ä½éšã€‚macdæ³¢æ®µå¾ <span class='green-text'>2</span> èµ°å‘ <span class='${colorClass}'>${finalLabel}</span>ï¼Œè§€å¯Ÿé—œéµé–€å‹•æ…‹ã€‚è‹¥èµ°å‘ C ä»£è¡¨å·²å®Œæˆ 3-A-B çš„èƒ½é‡æ¶ˆè€—ã€‚çµè«–ï¼š${conclusion}`,
            '3': `ğŸ”¥ <b class='red-text'>ç™¼å‹•æ€§è³ª (3è½‰2/A)</b>ï¼šç™¼å‹•ä½éšã€‚macdæ³¢æ®µå¾ <span class='red-text'>3</span> èµ°å‘ <span class='${colorClass}'>${finalLabel}</span>ï¼Œè§€å¯Ÿé—œéµé–€å‹•æ…‹ã€‚çµè«–ï¼š${conclusion}`,
            'A': `ğŸ“‰ <b class='green-text'>èµ·è·Œæ€§è³ª (Aè½‰B)</b>ï¼šèµ·è·Œä½éšã€‚macdæ³¢æ®µå¾ <span class='green-text'>A</span> èµ°å‘ <span class='${colorClass}'>${finalLabel}</span>ï¼Œè§€å¯Ÿé—œéµé–€å‹•æ…‹ã€‚çµè«–ï¼š${conclusion}`,
            'B': `âš–ï¸ <b class='blue-text'>è½‰åŒ–è‡¨ç•Œ (Bè½‰1/C)</b>ï¼šåå½ˆä½éšã€‚macdæ³¢æ®µå¾ <span class='red-text'>B</span> èµ°å‘ <span class='${colorClass}'>${finalLabel}</span>ï¼Œè§€å¯Ÿé—œéµé–€å‹•æ…‹. çµè«–ï¼š${conclusion}`,
            'C': `ğŸ’€ <b class='green-text'>ä¸»è·Œæ€§è³ª (Cè½‰B/1)</b>ï¼šä¸‹æ®ºä½éšã€‚macdæ³¢æ®µå¾ <span class='green-text'>C</span> èµ°å‘ <span class='${colorClass}'>${finalLabel}</span>ï¼Œè§€å¯Ÿé—œéµé–€å‹•æ…‹ã€‚çµè«–ï¼š${conclusion}`
        };
        return scripts[wave] || `â¡ macdæ³¢æ®µèµ°å‘ ${finalLabel}ï¼Œè§€å¯Ÿé—œéµé–€ã€‚çµè«–ï¼š${conclusion}`;
    }

    function initUI() {
        const panel = document.getElementById('inputPanel');
        panel.innerHTML = '';
        timeframes.forEach(tf => {
            const row = document.createElement('div');
            row.className = 'level-row';
            row.innerHTML = `
                <div class="level-label">${tf.name}ç´šåˆ¥</div>
                <div class="input-item" data-label="ç•¶ä¸‹æ³¢å‹•"><select id="wave_${tf.id}"><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></div>
                <div class="input-item" data-label="ç•¶ä¸‹ä¸ƒå­—è¨£"><select id="mantra_${tf.id}"><option value="UP">å‘ä¸Š (ç´…)</option><option value="DOWN">å‘ä¸‹ (ç¶ )</option></select></div>
                <div class="input-item" data-label="ç•¶ä¸‹ M é–€ (å¤©)"><select id="m_gate_${tf.id}"><option value="NONE">1.ç„¡é–€</option><option value="FORMING">2.å½¢æˆä¸­</option><option value="OPEN">3.å·²é–‹å•Ÿ</option><option value="CLOSED">4.å·²é—œé–‰</option></select></div>
                <div class="input-item" data-label="ç•¶ä¸‹ W é–€ (åœ°)"><select id="w_gate_${tf.id}"><option value="NONE">1.ç„¡é–€</option><option value="FORMING">2.å½¢æˆä¸­</option><option value="OPEN" selected>3.å·²é–‹å•Ÿ</option><option value="CLOSED">4.å·²é—œé–‰</option></select></div>
            `;
            panel.appendChild(row);
        });
    }

    function runSystemAnalysis() {
        const steps = parseInt(document.getElementById('stepCount').value) || 60;
        const refIdx = parseInt(document.getElementById('refLevel').value);
        const tbody = document.querySelector('#mainTable tbody');
        tbody.innerHTML = '';

        let matrix = timeframes.map(tf => ({
            id: tf.id, name: tf.name, ratio: tf.ratio, weight: tf.weight,
            wave: document.getElementById(`wave_${tf.id}`).value,
            mantra: document.getElementById(`mantra_${tf.id}`).value, 
            wGate: document.getElementById(`w_gate_${tf.id}`).value,
            mGate: document.getElementById(`m_gate_${tf.id}`).value
        }));

        let curV = 0;
        matrix.forEach(m => {
            let v = [0, 2, 4].includes(labelMap[m.wave]) ? 1 : -1;
            if (m.mantra === 'DOWN') v -= 0.5;
            if (m.wGate === 'OPEN') v += 1.5;
            if (m.mGate === 'OPEN') v -= 1.5;
            if (m.wGate === 'CLOSED') v -= 2.0; 
            if (m.mGate === 'CLOSED') v += 1.0;
            curV += v * (m.weight / 10);
        });

        const tm = document.getElementById('trendMeter');
        const tc = document.getElementById('trendMeterCard');
        if (curV > 4.5) { tm.innerHTML = "<span class='red-text'>å‘ä¸Šç™¼æ•£æ€§è³ªä¸»å° ğŸš€</span>"; tc.className = "meter-card up"; }
        else if (curV < -4.5) { tm.innerHTML = "<span class='green-text'>å‘ä¸‹é‡åŠ›æ€§è³ªä¸»å° ğŸ“‰</span>"; tc.className = "meter-card down"; }
        else { tm.innerHTML = "éœ‡ç›ªå¹³è¡¡æ•´ç† âš–ï¸"; tc.className = "meter-card"; }

        let pMax = 0, pStep = 0;
        for (let s = 1; s <= steps; s++) {
            let tp = 0; matrix.forEach(m => { if([0,2,4].includes((labelMap[m.wave] + Math.floor(s/m.ratio)) % 6)) tp += m.weight; });
            if (tp > pMax) { pMax = tp; pStep = s; }
        }
        document.getElementById('scenarioText').innerHTML = `æˆ°ç•¥é åˆ¤ï¼šStep ${pStep} ç‚ºèƒ½é‡é«˜å³°ã€‚æ ¸å¿ƒé‰¸éˆï¼š<b class='red-text'>${matrix[refIdx].name}ç´š ç©ºé–“é–€æ§ç‹€æ…‹</b>ã€‚`;
        document.getElementById('defensePoint').innerHTML = `ğŸ”¼ å®è§€ï¼š${getGateStatusHtml(matrix[refIdx-1]?.wGate, 'W_GATE', matrix[refIdx-1]?.name)}<br>ğŸ¯ åŸºæº–ï¼š${matrix[refIdx].name} é€±æœŸè¯å‹•<br>ğŸ”½ æ‰³æ©Ÿï¼š${getGateStatusHtml(matrix[refIdx+1]?.wGate, 'W_GATE', matrix[refIdx+1]?.name)}`;

        for (let s = 1; s <= steps; s++) {
            let tags = []; let p = 0;
            matrix.forEach(m => {
                let idx = (labelMap[m.wave] + Math.floor(s / m.ratio)) % 6;
                tags.push(idx); if ([0,2,4].includes(idx)) p += m.weight;
            });
            const gStatus = getGateStatus(tags[refIdx]);
            const row = document.createElement('tr');
            row.innerHTML = `<td><b>Step ${s}</b></td>${tags.map(v=>`<td><span class="tag-cell ${[0,2,4].includes(v)?'tag-up':'tag-down'}">${labels[v]}</span></td>`).join('')}<td><span class="${gStatus.cls}">${gStatus.txt}</span></td><td style="text-align:left; padding-left:25px;">${getPracticalAnalysis(tags[refIdx], p, matrix[refIdx].name, tags)}</td>`;
            tbody.appendChild(row);
        }
    }

    function generateReportCard() {
        const prod = document.getElementById('productName').value || "ç•¶å‰æ¨™çš„";
        const time = new Date().toLocaleString();
        const steps = parseInt(document.getElementById('stepCount').value) || 60;
        const refIdx = document.getElementById('refLevel').selectedIndex;
        const refName = document.getElementById('refLevel').options[refIdx].text;
        const cardId = 'card_' + Date.now();

        let matrix = timeframes.map(tf => ({
            id: tf.id, name: tf.name, ratio: tf.ratio, weight: tf.weight,
            wave: document.getElementById(`wave_${tf.id}`).value,
            wGate: document.getElementById(`w_gate_${tf.id}`).value,
            mGate: document.getElementById(`m_gate_${tf.id}`).value,
            mantra: document.getElementById(`mantra_${tf.id}`).value
        }));

        const getGroupDetail = (indices) => {
            return indices.map(i => {
                const m = matrix[i];
                const startIdx = labelMap[m.wave];
                const endIdx = (startIdx + Math.floor(steps / m.ratio)) % 6;
                const startLabel = labels[startIdx];
                const endLabel = labels[endIdx];
                const startColor = [0,2,4].includes(startIdx) ? 'red-text' : 'green-text';
                const endColor = [0,2,4].includes(endIdx) ? 'red-text' : 'green-text';
                const conclusion = getRangeConclusion(m);
                return `<div style="margin-bottom:8px; padding-left:15px; border-left:4px solid #ddd;"><b>${m.name}ç´šåˆ¥æ¨æ¼”:</b> macdæ³¢æ®µå¾ <span class="${startColor}">${startLabel}</span> èµ°å‘ <span class="${endColor}">${endLabel}</span>ã€‚çµè«–ï¼š${conclusion}</div>`;
            }).join('');
        };

        const macroDetails = getGroupDetail([0, 1, 2]);
        const triggerDetails = getGroupDetail([4, 5, 6]);

        const part1Html = `
            <div class="part-box">
                <div class="part-header">ğŸ¯ ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæº–æˆ°ç•¥å°èˆª</div>
                <div class="summary-item"><span class="blue-text">è¶¨å‹¢çµè«–ï¼š</span> ${document.getElementById('trendMeter').innerHTML}</div>
                <div class="summary-item"><span class="blue-text">æ™ºæ…§é è¨€ï¼š</span> ${document.getElementById('scenarioText').innerHTML}</div>
                <div class="summary-item">
                    <span class="blue-text">åˆ†çµ„é˜²å®ˆè¯å‹•åˆ†æï¼š</span><br>
                    <div style="background:#fff; border-radius:20px; padding:25px; border:2px solid #edf2f7; margin-top:15px;">
                        <div style="margin-bottom:20px;">
                            <b class="text-dark">â–  å®è§€ä½éš (æœˆ/é€±/æ—¥)</b><br>
                            ${macroDetails}
                        </div>
                        <div>
                            <b class="text-dark">â–  è¶¨å‹¢æ‰³æ©Ÿ (60M/15M/5M)</b><br>
                            ${triggerDetails}
                        </div>
                    </div>
                </div>
                <div class="summary-item" style="border-bottom:none;">
                    <span class="blue-text">æ ¸å¿ƒæˆ°ç•¥ç¸½çµï¼š</span><br>
                    è‹¥åŸºæº–æˆåŠŸ<b class='red-text'>é–‹é–€å‘ä¸Š</b>ï¼Œå°‡å•Ÿå‹•å…¨é€±æœŸ 123 <b class='red-text'>èµ·æ¼²ç™¼å‹•</b>ï¼›è‹¥å—é˜»ç¢ºèª<b class='green-text'>é—œé–€å‘ä¸‹</b>ï¼Œæ€§è³ªç”±ç´…è½‰ç¶ å¼•ç™¼é‡åŠ›å¡Œé™·ã€‚
                </div>
            </div>
        `;

        let summaryList = "";
        matrix.forEach((m) => {
            const tagIdx = labelMap[m.wave];
            const isUp = [0,2,4].includes(tagIdx);
            summaryList += `
                <div class="summary-item">
                    <div style="display:flex; justify-content:space-between; font-weight:900; margin-bottom:15px;">
                        <span class="blue-text">${m.name}ç´šåˆ¥æ¨æ¼”:</span>
                        <span class="${isUp?'red-text':'green-text'}">${isUp?'ğŸ”“é–‹é–€':'ğŸ”’é—œé–€'} | ${labels[tagIdx]}</span>
                    </div>
                    <div style="color:#555; font-size:1rem; padding-left:25px; border-left:6px solid var(--accent); line-height:1.9;">
                        ${getLevelMetaScript(m, steps)}
                    </div>
                </div>`;
        });

        const card = document.createElement('div');
        card.id = cardId; card.className = 'report-card';
        card.innerHTML = `
            <span class="close-btn" onclick="this.parentElement.remove(); updateBadge();">Ã—</span>
            <h4>ğŸ“Š å•†å“æˆ°ç•¥å ±å‘Šï¼š${prod}</h4>
            <span class="timestamp">åˆ†æç”¢å‡ºï¼š${time} | åŸºæº–ï¼š${refName}</span>
            ${part1Html}
            <div class="part-box">
                <div class="part-header">ğŸ“ˆ ç¬¬äºŒéƒ¨åˆ†ï¼šå…¨ç´šåˆ¥é›™å‘æ¼”åŒ–çŸ©é™£</div>
                ${summaryList}
            </div>
            <div class="report-footer-disclaimer">
                ç¨‹å¼æ¼”ç®—æ³•æ’°å¯«ï¼šå…­ç”²è±†å­<br>
                âš ï¸ æ³¨æ„ï¼šå€‹äººäº¤æ˜“å¿ƒå¾—æ•´ç†ï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ï¼›ç‰›è»é–‹é–€æ•™å­¸è«‹è‡ªè¡Œåˆ° <a href="https://www.skool.com/niujun-open-the-door/about?ref=35d3add8e5c64bb58850c92c283d1ba4" target="_blank">SKOOL æŠ€è¡“åŸå‰µè€…</a> å­¸ç¿’
            </div>
            <div class="report-actions" style="margin-top:40px; text-align:center;"><button class="btn btn-primary" onclick="saveAsImage('${cardId}')">ğŸ“¸ å„²å­˜å ±å‘Šåœ–ç‰‡</button></div>
        `;
        document.getElementById('reportGallery').prepend(card);
        document.getElementById('emptyHint').style.display = 'none';
        updateBadge(); switchTab('report');
    }

    async function saveAsImage(id) {
        const card = document.getElementById(id);
        const acts = card.querySelector('.report-actions');
        const close = card.querySelector('.close-btn');
        if(acts) acts.style.display = 'none'; 
        if(close) close.style.display = 'none';
        const canvas = await html2canvas(card, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
        const link = document.createElement('a');
        link.download = `ç‰›è½‰é–€æˆ°ç•¥åˆ†æ_${Date.now()}.png`; link.href = canvas.toDataURL("image/png"); link.click();
        if(acts) acts.style.display = 'block'; 
        if(close) close.style.display = 'block';
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tabBtn' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        document.getElementById('content' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
    }

    function updateBadge() { document.getElementById('reportCount').innerText = document.getElementById('reportGallery').children.length; }
    function loadExample() {
        const ex = ['3','3','3','A','3','C','C','1'];
        timeframes.forEach((tf, i) => { document.getElementById(`wave_${tf.id}`).value = ex[i]; });
        runSystemAnalysis();
    }

    window.onload = initUI;
</script>

</body>
</html>