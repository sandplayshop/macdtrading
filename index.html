<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a73e8">
    <title>ç‰›è½‰é–€ï¼šæ™‚ç©ºå°èˆªå„€ (çµ‚æ¥µå®Œå…¨ç‰ˆ)</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuWIm+i9iee6gOaZgum6uuiwsOatueitpOakrCIsCiAgInNob3J0X25hbWUiIjogIuWIm+i9iee6gCIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjRmN2Y5IiwKICAidGhlbWVfY29sb3IiOiAiIzFhNzNlOCIKfQ==">

    <style>
        :root {
            --primary: #1a73e8;
            --primary-hover: #1557b0;
            --bg: #f4f7f9;
            --card: #ffffff;
            --up-red: #d32f2f;
            --down-green: #388e3c;
            --warning: #f9ab00;
            --border: #dadce0;
            --text-main: #202124;
            --text-sub: #5f6368;
            --harmony-gold: #ffd700;
            --gate-blue: #0288d1;
            --puzzle-purple: #7b1fa2;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 10px; color: var(--text-main); margin: 0; }

        .container { width: 100%; max-width: 1850px; margin: 0 auto; background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 4px 30px rgba(0,0,0,0.1); }
        
        header { text-align: center; margin-bottom: 10px; border-bottom: 3px solid var(--primary); padding-bottom: 10px; }
        h1 { color: var(--primary); margin: 0; font-size: clamp(1.2rem, 4vw, 1.8rem); }
        .description { color: var(--text-sub); font-size: 0.85rem; margin-top: 5px; font-weight: 500; }

        /* æŠ€è¡“æ ¸å¿ƒå°è®€å€ */
        .core-concept-card {
            background: #f8fbff;
            border: 1px solid #d1e3ff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0 20px 0;
            box-shadow: inset 0 0 10px rgba(26, 115, 232, 0.05);
        }
        .core-concept-card h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: var(--primary);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .concept-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .concept-item {
            font-size: 0.85rem;
            line-height: 1.5;
            color: #444;
        }
        .concept-item b { color: var(--text-main); border-bottom: 2px solid #ddd; }

        /* å„€è¡¨æ¿ */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .meter-card { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 12px; text-align: center; display: flex; flex-direction: column; justify-content: center; min-height: 120px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .meter-title { font-size: 0.8rem; font-weight: bold; color: var(--text-sub); margin-bottom: 6px; border-bottom: 1px solid #f1f3f4; padding-bottom: 4px; }
        .meter-value { font-size: 1rem; font-weight: 900; line-height: 1.4; }
        .trend-up { color: var(--up-red); }
        .trend-down { color: var(--down-green); }

        /* æ¥µç«¯è¡Œæƒ…è­¦ç¤ºå€ */
        .alert-panel { 
            display: none; 
            background: #fff; 
            border: 2px solid #ff0000; 
            border-radius: 10px; 
            padding: 15px; 
            margin-bottom: 20px; 
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.1);
        }
        .alert-title { font-weight: 900; font-size: 1.1rem; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .alert-body { font-size: 0.9rem; line-height: 1.7; color: #333; }
        .alert-status { display: inline-block; padding: 2px 8px; border-radius: 4px; background: #eee; font-weight: bold; margin-top: 5px; }

        /* é…ç½®é¢æ¿ */
        .config-panel { background: #ffffff; padding: 12px; border-radius: 10px; margin-bottom: 20px; border: 1px solid var(--border); }
        .level-row { display: grid; grid-template-columns: 50px 1fr 1fr 1fr 1fr; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f3f4; }
        .level-label { font-weight: 800; font-size: 13px; color: var(--primary); text-align: center; }
        
        @media (max-width: 850px) {
            .level-row { grid-template-columns: 1fr 1fr; }
            .level-label { grid-column: span 2; background: #e8f0fe; padding: 4px; border-radius: 4px; }
        }

        .input-item { display: flex; flex-direction: column; }
        .input-item label { font-size: 10px; color: #777; margin-bottom: 2px; text-align: center; font-weight: bold; }
        select, input { padding: 6px; border-radius: 6px; border: 1px solid var(--border); font-size: 12px; text-align: center; background: #fdfdfd; width: 100%; cursor: pointer; }

        .actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
        .btn { padding: 12px 40px; border-radius: 25px; font-weight: bold; cursor: pointer; border: none; font-size: 14px; background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(26,115,232,0.3); transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: white; color: var(--primary); border: 1px solid var(--primary); }

        /* è¡¨æ ¼å€ */
        .result-box { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: #fff; margin-bottom: 20px; }
        .scroll-area { max-height: 55vh; overflow: auto; position: relative; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 11px; min-width: 1400px; }
        thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 20; padding: 12px 4px; border-bottom: 2px solid var(--primary); font-weight: 800; }
        td:first-child, th:first-child { position: sticky; left: 0; background: #f8f9fa; z-index: 10; border-right: 2px solid var(--border); font-weight: 800; }
        
        td { padding: 10px 4px; text-align: center; border-bottom: 1px solid #f1f3f4; }
        
        .tag-cell { font-weight: 800; border-radius: 4px; padding: 4px 8px; display: inline-block; min-width: 28px; }
        .tag-up { color: #b71c1c; background: #ffebee; border: 1px solid #ef9a9a; } 
        .tag-down { color: #1b5e20; background: #e8f5e9; border: 1px solid #a5d6a7; }

        .level-badge { font-weight: 900; padding: 2px 8px; border-radius: 4px; font-size: 11px; display: inline-block; margin-bottom: 3px; min-width: 90px; text-align: center; background: transparent; border: 1px solid currentColor; }
        .p-1, .p-2 { color: var(--up-red); border-color: var(--up-red); } 
        .p-3 { color: var(--primary); border-color: var(--primary); } 
        .p-4, .p-5 { color: var(--down-green); border-color: var(--down-green); } 

        .gate-status-tag { font-size: 10px; font-weight: 800; padding: 2px 6px; border-radius: 4px; display: block; margin-bottom: 2px; text-transform: uppercase; border: 1px solid transparent; }
        .gs-open { color: #ff0000; border-color: #ff0000; } 
        .gs-close { color: var(--down-green); border-color: var(--down-green); } 
        .gs-alert { color: #ff0000; border-color: #ff0000; } 

        .power-text { font-size: 10px; font-weight: bold; color: #777; margin-top: 4px; }

        .golden-puzzle { background: #fffdf0 !important; border-left: 6px solid var(--harmony-gold); } 
        .critical-kick { background: #fdf2ff !important; border-left: 5px solid var(--puzzle-purple); } 

        /* åº•éƒ¨å¿ƒæ³•èªªæ˜èˆ‡å…è²¬è²æ˜ */
        .footer-notes { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; padding: 25px; background: #ffffff; border: 1px solid var(--border); border-radius: 12px; margin-top: 20px; }
        .note-card h3 { color: var(--primary); font-size: 1.1rem; margin-top: 0; border-left: 4px solid var(--primary); padding-left: 12px; margin-bottom: 12px; }
        .note-card p, .note-card li { font-size: 0.85rem; color: #333; line-height: 1.7; }
        .note-card ul { padding-left: 20px; }
        .note-card b { font-weight: 800; }
        .note-card .red-text { color: #ff0000; font-weight: bold; }
        .note-card .green-text { color: var(--down-green); font-weight: bold; }
        .note-card .blue-text { color: var(--primary); font-weight: bold; }

        .app-attribution {
            margin-top: 30px;
            padding: 20px;
            border-top: 1px solid #eee;
            text-align: center;
            color: var(--text-sub);
            font-size: 0.8rem;
            line-height: 1.8;
        }
        .skool-link {
            color: var(--primary);
            text-decoration: underline;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ç‰›è½‰é–€ï¼šæ³¢å‹•ãƒ»æ™‚ç©ºå°èˆªå„€</h1>
        <div class="description">ä¸‰å±¤ç´šè¯å‹•ç›£æ¸¬ | é–€æ§è½‰æ…‹åµæ¸¬ | æ•¸æ“šæ¥µç°¡ç‰ˆ</div>
    </header>

    <!-- æŠ€è¡“æ ¸å¿ƒå°è®€å€ -->
    <div class="core-concept-card">
        <h3>ğŸ”‘ ç‰›è»é–‹é–€æŠ€è¡“æ ¸å¿ƒï¼š7å­—è¨£ãƒ»é–€ãƒ»æ³¢å‹•</h3>
        <div class="concept-grid">
            <div class="concept-item">
                <b>ğŸŒŠ è­˜æ³¢å‹•</b>ï¼šè­˜åˆ¥ 123 (èµ·ã€è¸©ã€å‡) èˆ‡ ABC (è·Œã€æŠ½ã€æ®º)ã€‚çœ‹æ¸…ç‰©ç†è½‰å‹•ï¼Œå‘Šåˆ¥çŒœæ¸¬ã€‚
            </div>
            <div class="concept-item">
                <b>ğŸ”¢ 7å­—è¨£</b>ï¼š<b>ã€Œè¦‹ç´…ä¹‹å¾Œç­‰è¦‹é»‘ï¼Œè¦‹é»‘ä¹‹å¾Œç­‰è¦‹ç´…ã€</b>ã€‚åˆ©ç”¨ MACD å †æ¸¬é‡æ³¢å‹•å¼·åº¦ã€‚
            </div>
            <div class="concept-item">
                <b>ğŸšª å®šé–€æ§</b>ï¼šé–€æ˜¯ç‰©ç†é‚Šç•Œã€‚<b>æ”¶ç›¤åƒ¹ç«™ä¸Š Wé–€ çœ‹å¤šï¼Œè·Œç ´ Mé–€ çœ‹ç©º</b>ã€‚é–€ä¸‹ä¸åšå¤šï¼Œé–€ä¸Šä¸åšç©ºã€‚
            </div>
        </div>
    </div>

    <!-- æ¥µç«¯è¡Œæƒ…è½‰æŠ˜è­¦ç¤ºå€ -->
    <div id="extremeAlert" class="alert-panel">
        <div id="alertTitle" class="alert-title"></div>
        <div id="alertBody" class="alert-body"></div>
        <div id="alertCounter" class="alert-status"></div>
    </div>

    <div class="dashboard">
        <div class="meter-card">
            <div class="meter-title">ç•¶å‰å¤šç©ºè©•åˆ†èˆ‡è­¦èª</div>
            <div id="trendMeter" class="meter-value" style="font-size:1rem;">ç­‰å¾…æ¨æ¼”...</div>
        </div>
        <div class="meter-card">
            <div class="meter-title">æœªä¾†æ¼”åŒ–é è¨€ (Scenario)</div>
            <div id="scenarioText" style="font-size: 0.85rem; font-weight: 600; color: #444;">è«‹è¼¸å…¥åƒæ•¸å¾Œé»æ“Šæ¨æ¼”</div>
        </div>
        <div class="meter-card">
            <div class="meter-title">çµ•å°é˜²ç¦¦è¯å‹• (Risk Control)</div>
            <div id="defensePoint" class="meter-value" style="color: #333; font-size: 0.85rem; text-align: left; padding-left: 10px;">
                è«‹é¸æ“‡å°èˆªåŸºæº–å¾ŒåŸ·è¡Œ
            </div>
        </div>
    </div>

    <div class="config-panel" id="inputPanel">
        <!-- JS å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <div class="actions">
        <button class="btn btn-outline" onclick="loadExample()">è¼‰å…¥ç¯„ä¾‹ (333A3CC1)</button>
        <div class="input-item" style="min-width:180px;">
            <label>å°èˆªåŸºæº–å±¤ç´š</label>
            <select id="refLevel">
                <option value="0">æœˆç·šåŸºæº–</option><option value="1">é€±ç·šåŸºæº–</option><option value="2">æ—¥ç·šåŸºæº–</option>
                <option value="3" selected>4H åŸºæº–</option>
                <option value="4">60m åŸºæº–</option><option value="5">15m åŸºæº–</option>
                <option value="6">5m åŸºæº–</option><option value="7">1m åŸºæº–</option>
            </select>
        </div>
        <div class="input-item" style="min-width:100px;">
            <label>é æ¼”æ­¥æ•¸</label>
            <input type="number" id="stepCount" value="60" min="1">
        </div>
        <button class="btn" onclick="runSystemAnalysis()">åŸ·è¡Œå¤šé€±æœŸçŸ©é™£æ¨æ¼”</button>
    </div>

    <!-- è¡¨æ ¼å€ -->
    <div class="result-box">
        <div class="scroll-area">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th style="width: 85px;">æ­¥æ•¸ / çª—å£</th>
                        <th>æœˆ</th><th>é€±</th><th>æ—¥</th><th>4H</th><th>60m</th><th>15m</th><th>5m</th><th>1m</th>
                        <th style="width: 190px;">èƒ½é‡ãƒ»ç‹€æ…‹ / é–€æ§</th>
                        <th style="min-width:400px;">ç‰›è½‰é–€å¯¦æˆ°è§£æ (æ”¶ç›¤ç¢ºèªæœ‰æ•ˆ)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="footer-notes">
        <div class="note-card">
            <h3>âš¡ èƒ½é‡ç­‰ç´šèªªæ˜</h3>
            <ul>
                <li><b class="red-text">1. æ¥µå¤š</b>ï¼šå…¨é€±æœŸå‘ä¸Šå…±æŒ¯ï¼Œèƒ½é‡å™´ç™¼ï¼Œä¸»å‡æ®µæœ€å¼·æ…£æ€§ã€‚</li>
                <li><b class="red-text">2. å¼·å¤š</b>ï¼šæ­£å¼¦ç›¸ä½ (1, 3, B) ä¸»å°ï¼Œå¤šé ­è¶¨å‹¢ç¢ºç«‹ï¼Œå›æ¸¬è²·é»ã€‚</li>
                <li><b class="blue-text">3. å¤šç©ºé—œéµ</b>ï¼šè‡¨ç•Œé»ï¼Œæ€§è³ªè½‰åŒ–ä¸­ï¼Œè§€å¯Ÿå°é½’è¼ªå¼•å‹•æ–¹å‘ã€‚</li>
                <li><b class="green-text">4. ç©ºèª˜å¤š</b>ï¼šB æ®µåå½ˆï¼Œå±¬æ–¼é¤˜å¼¦æ³¢ä¿®æ­£æ€§è³ªï¼Œæº–å‚™éš¨æ™‚è½‰å‘ã€‚</li>
                <li><b class="green-text">5. ç©ºé ­</b>ï¼šé¤˜å¼¦ç›¸ä½ (2, A, C) ä¸»å°ï¼Œé‡åŠ›åŠ é€Ÿï¼Œåš´ç¦æŠ„åº•ã€‚</li>
            </ul>
        </div>
        <div class="note-card">
            <h3>ğŸšª é–€æ§æ©Ÿç†èªªæ˜</h3>
            <ul>
                <li><b class="red-text">ğŸ”“ é–‹é–€ç™¼å‹•</b>ï¼šåƒ¹æ ¼çªç ´ W é–€(åº•)æˆ– M é–€(é ­)ï¼Œæ–°ç©ºé–“è¢«æœ‰æ•ˆé–‹å•Ÿã€‚</li>
                <li><b class="red-text">ğŸ”„ æ¸¬é–€è²·é»</b>ï¼šæ¨™ç±¤ 2 å›æ¸¬ä¸ç ´é–€(ä¸­è»Œ)ï¼Œæ˜¯ç‰›è½‰é–€æœ€ç²¾ç¢ºè²·é»ã€‚</li>
                <li><b class="red-text">âš ï¸ Båå½ˆæ‰¾ç©ºé»</b>ï¼šB æ®µåå½ˆå—é˜»æ–¼å£“åŠ›é–€ï¼Œæ˜¯èª˜å¤šæ‰¾ç©ºçš„ä¼æ“Šä½ç½®ã€‚</li>
                <li><b class="green-text">ğŸ”’ é—œé–€æ’¤é€€</b>ï¼šåƒ¹æ ¼ç¸®å›é–€å…§ï¼Œä»£è¡¨æ³¢å‹•æ€§è³ªçµæŸï¼Œæ‡‰ç«‹å³é›¢å ´ã€‚</li>
            </ul>
        </div>
        <div class="note-card">
            <h3>ğŸ·ï¸ æ¨™ç±¤å±¬æ€§ (ç´…æ¼²ç¶ è·Œ)</h3>
            <ul>
                <li><b class="red-text">1, 3, B</b>ï¼šæ­£å¼¦ç›¸ä½ã€‚ä»£è¡¨å‘ä¸Šç™¼æ•£ã€èµ·æ¼²ã€ä¸»å‡æˆ–å›å‡èƒ½é‡ã€‚</li>
                <li><b class="green-text">2, A, C</b>ï¼šé¤˜å¼¦ç›¸ä½ã€‚ä»£è¡¨å‘ä¸‹ä¿®æ­£ã€åˆè·Œã€ä¸»è·Œæˆ–é‡åŠ›å›è¸©ã€‚</li>
                <li><b>æ”¶ç›¤ç¢ºèª</b>ï¼šæ‰€æœ‰ç‹€æ…‹åˆ‡æ›èˆ‡é–‹é—œé–€ï¼Œå¿…é ˆä»¥<b>è©²é€±æœŸæ”¶ç›¤åƒ¹</b>ç‚ºæº–ã€‚</li>
            </ul>
        </div>
        <div class="note-card">
            <h3>ğŸ“ˆ å°èˆªå±¤ç´šå®šä½</h3>
            <ul>
                <li><b>æœˆ/é€±/æ—¥ (å®è§€)</b>ï¼šå®šç¾©ã€Œæ™‚ä»£é‡åŠ›ã€ï¼Œæ±ºå®šå¤§è¶¨å‹¢çš„é–‹é–€èˆ‡é—œé–€ã€‚</li>
                <li><b>4H/60m (ä¸­æœŸ)</b>ï¼šå®šç¾©ã€Œæ³¢æ®µæ¨™ç«¿ã€ï¼Œåˆ¤å®šç•¶æ—¥å¼·å¼±èˆ‡é˜²ç¦¦è‡¨ç•Œä½ã€‚</li>
                <li><b>15m/5m/1m (å¾®è§€)</b>ï¼šå®šç¾©ã€Œé€²å ´æ¿æ©Ÿã€ï¼Œæ•æ‰ã€Œå—ç²¾åµã€é–‹é–€å¼•å‹•æ•ˆæ‡‰ã€‚</li>
            </ul>
        </div>
    </div>

    <!-- ç½²åèˆ‡å…è²¬è²æ˜å€ -->
    <div class="app-attribution">
        ç¨‹å¼æ’°å¯«ï¼šå…­ç”²è±†å­<br>
        âš ï¸ æ³¨æ„ï¼šå€‹äººäº¤æ˜“å¿ƒå¾—æ•´ç†ï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ï¼›ç‰›è»é–‹é–€æ•™å­¸è«‹è‡ªè¡Œåˆ° <a href="https://www.skool.com/niujun-open-the-door/about?ref=35d3add8e5c64bb58850c92c283d1ba4" target="_blank" class="skool-link">SKOOL æŠ€è¡“åŸå‰µè€…</a> å­¸ç¿’ï¼Œå°Šé‡æŠ€è¡“åŸå‰µè€…
    </div>
</div>

<script>
    const timeframes = [
        { id: 'M', name: 'æœˆ', weight: 25, ratio: 43200 },
        { id: 'W', name: 'é€±', weight: 18, ratio: 10080 },
        { id: 'D', name: 'æ—¥', weight: 14, ratio: 1440 },
        { id: '4H', name: '4H', weight: 12, ratio: 240 },
        { id: '60m', name: '60m', weight: 10, ratio: 60 },
        { id: '15m', name: '15m', weight: 8, ratio: 15 },
        { id: '5m', name: '5m', weight: 8, ratio: 5 },
        { id: '1m', name: '1m', weight: 5, ratio: 1 }
    ];

    const levelNames = timeframes.map(tf => tf.name);
    const labels = ['1', '2', '3', 'A', 'B', 'C'];
    const labelMap = {'1':0, '2':1, '3':2, 'A':3, 'B':4, 'C':5};

    function initUI() {
        const panel = document.getElementById('inputPanel');
        panel.innerHTML = ''; 
        timeframes.forEach(tf => {
            const row = document.createElement('div');
            row.className = 'level-row';
            row.innerHTML = `
                <div class="level-label">${tf.name}</div>
                <div class="input-item">
                    <label>æ³¢å‹•æ¨™ç±¤</label>
                    <select id="wave_${tf.id}">
                        <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option>
                        <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                    </select>
                </div>
                <div class="input-item"><label>7å­—è¨£æ–¹å‘</label><select id="mantra_${tf.id}"><option value="UP">UP</option><option value="DOWN">DOWN</option></select></div>
                <div class="input-item"><label>é–€å±¬æ€§</label><select id="gateType_${tf.id}"><option value="NONE">ç„¡é–€</option><option value="W_GATE">W é–€</option><option value="M_GATE">M é–€</option></select></div>
                <div class="input-item"><label>é–€é–‹é—œ</label><select id="gateStatus_${tf.id}"><option value="FORMING">å½¢æˆä¸­</option><option value="OPEN">å·²é–‹å•Ÿ</option><option value="CLOSED">å·²é—œé–‰</option></select></div>
            `;
            panel.appendChild(row);
        });
    }

    function loadExample() {
        const ex = ['3','3','3','A','3','C','C','1'];
        timeframes.forEach((tf, i) => {
            document.getElementById(`wave_${tf.id}`).value = ex[i];
        });
        runSystemAnalysis();
    }

    function getGateStatusHtml(m) {
        if (!m) return "-";
        const typeTxt = m.gateType === 'W_GATE' ? 'Wé–€' : (m.gateType === 'M_GATE' ? 'Mé–€' : 'ç„¡é–€');
        const statusTxt = m.gateStatus === 'OPEN' ? '<span style="color:var(--up-red)">å·²é–‹</span>' : (m.gateStatus === 'CLOSED' ? '<span style="color:var(--down-green)">å·²é—œ</span>' : 'å½¢æˆä¸­');
        return `<b>${m.name}ç´š</b>: ${typeTxt}(${statusTxt})`;
    }

    function runSystemAnalysis() {
        const steps = parseInt(document.getElementById('stepCount').value) || 60;
        const refIdx = parseInt(document.getElementById('refLevel').value);
        const tbody = document.querySelector('#mainTable tbody');
        tbody.innerHTML = '';

        let matrix = timeframes.map(tf => ({
            id: tf.id, name: tf.name, ratio: tf.ratio, weight: tf.weight,
            wave: document.getElementById(`wave_${tf.id}`).value,
            mantra: document.getElementById(`mantra_${tf.id}`).value, 
            gateType: document.getElementById(`gateType_${tf.id}`).value, 
            gateStatus: document.getElementById(`gateStatus_${tf.id}`).value
        }));

        // 1. å¤šç©ºè©•åˆ†
        let currentVector = 0;
        matrix.forEach(m => {
            let v = [0, 2, 4].includes(labelMap[m.wave]) ? 1 : -1;
            if (m.wave === 'B' && m.mantra === 'DOWN') v = -1;
            currentVector += v * m.weight;
        });

        const trendMeter = document.getElementById('trendMeter');
        if (currentVector > 20) { trendMeter.innerHTML = "å¤šé ­æ…£æ€§å¼·çƒˆ ğŸš€"; trendMeter.className = "meter-card trend-up"; }
        else if (currentVector < -20) { trendMeter.innerHTML = "ç©ºé ­é‡åŠ›å¼·çƒˆ ğŸ“‰"; trendMeter.className = "meter-card trend-down"; }
        else { trendMeter.innerHTML = "ä¸­æ€§æ•´ç†å€ âš–ï¸"; trendMeter.className = "meter-card"; }

        // 2. æ¥µç«¯è¡Œæƒ…
        updateExtremeAlert(matrix);

        // 3. çµ•å°é˜²ç¦¦è¯å‹• (ä¸‰å±¤ç´šå±•ç¤º)
        const defensePoint = document.getElementById('defensePoint');
        // å‘ä¸Šå±¤ç´š (å®è§€): è‹¥åŸºæº–æ˜¯ 60m(4)ï¼Œä¸Šå±¤å– æ—¥(2) æˆ– 4H(3)
        // ç‚ºäº†ç¬¦åˆç”¨æˆ¶ã€Œæ—¥, 60M, 15Mã€éœ€æ±‚ï¼Œè‹¥ refIdx æ˜¯ 4 (60m)ï¼Œå– 2 (æ—¥)
        let macroIdx = refIdx >= 2 ? (refIdx === 4 ? 2 : refIdx - 1) : null;
        let microIdx = refIdx < 7 ? refIdx + 1 : null;

        let macroInfo = macroIdx !== null ? `ğŸ”¼ å®è§€ï¼š${getGateStatusHtml(matrix[macroIdx])}` : "";
        let targetInfo = `ğŸ¯ åŸºæº–ï¼š${getGateStatusHtml(matrix[refIdx])}`;
        let microInfo = microIdx !== null ? `ğŸ”½ å¾®è§€ï¼š${getGateStatusHtml(matrix[microIdx])}` : "";

        defensePoint.innerHTML = `${macroInfo}<br>${targetInfo}<br>${microInfo}`;

        // 4. æœªä¾†æ¼”åŒ–é è¨€ (ç™½è©±åŒ–)
        const scenarioText = document.getElementById('scenarioText');
        const isMicroOpen = labelMap[matrix[7].wave] === 0 || labelMap[matrix[7].wave] === 2;
        if (matrix[0].wave==='2' && matrix[1].wave==='C' && (matrix[2].wave==='1'||matrix[2].wave==='2')) {
            scenarioText.innerHTML = "âœ¨ <span style='color:var(--up-red)'>é»ƒé‡‘æ©Ÿæœƒ</span>ï¼šå¤§é€±æœŸæ­£åœ¨ä¼‘æ¯è“„å‹¢ï¼Œå°é€±æœŸç«è‹—å·²ç‡ƒã€‚å®Œç¾é€²å ´ï¼";
        } else if (isMicroOpen && currentVector < 0) {
            scenarioText.innerHTML = "âš™ï¸ <span style='color:var(--gate-blue)'>å¼•å‹•è§€å¯Ÿ</span>ï¼š1m/5m æ­£å˜—è©¦æ¨é–‹å¤§ç´šåˆ¥é–€ã€‚è§€å¯Ÿ " + matrix[refIdx].name + " æ˜¯å¦éæ”¶ç›¤ã€‚";
        } else {
            scenarioText.innerHTML = "âš–ï¸ çµæ§‹è“„å‹¢ï¼šç›®å‰å„ç´šåˆ¥æ­£åœ¨é€²è¡Œä½éšæ‹‰æ‰¯ï¼Œè§€å¯Ÿ " + matrix[refIdx].name + " ç´šåˆ¥é˜²ç·šã€‚";
        }

        // 5. æ¨æ¼”å¾ªç’°
        for (let s = 1; s <= steps; s++) {
            let rowTags = [];
            let totalPower = 0;

            matrix.forEach(m => {
                let curIdx = (labelMap[m.wave] + Math.floor(s / m.ratio)) % 6;
                rowTags.push(curIdx);
                if ([0, 2, 4].includes(curIdx)) totalPower += m.weight;
            });

            const tr = document.createElement('tr');
            if (rowTags[0] === 1 && rowTags[1] === 5 && (rowTags[2] === 0 || rowTags[2] === 1)) tr.className = "golden-puzzle";
            
            let html = `<td><b>Step ${s}</b></td>`;
            rowTags.forEach(v => {
                const isUp = [0, 2, 4].includes(v); 
                html += `<td><span class="tag-cell ${isUp ? 'tag-up' : 'tag-down'}">${labels[v]}</span></td>`;
            });
            
            let pLevel = getPowerLevel(totalPower);
            let gStatus = getGateStatus(rowTags[refIdx]);

            html += `<td>
                <span class="gate-status-tag ${gStatus.cls}">${gStatus.txt}</span>
                <span class="level-badge p-${pLevel.id}">${pLevel.name}</span>
                <div class="power-text">å…±æŒ¯èƒ½é‡: ${totalPower}%</div>
            </td>`;

            html += `<td class="analysis-col">æ­£åœ¨è§€å¯Ÿ ${levelNames[refIdx]} ç´šåˆ¥æ˜¯å¦èƒ½åœ¨ Step ${s} è™•ç¶­æŒé–‹é–€æ€§è³ªã€‚</td>`;
            tr.innerHTML = html;
            tbody.appendChild(tr);
        }
    }

    function updateExtremeAlert(matrix) {
        const panel = document.getElementById('extremeAlert');
        const title = document.getElementById('alertTitle');
        const body = document.getElementById('alertBody');
        const counter = document.getElementById('alertCounter');

        const macroWaves = matrix.slice(0, 5).map(m => m.wave);
        const isAll3 = macroWaves.every(w => w === '3');
        const isAllC = macroWaves.every(w => w === 'C');

        if (isAll3) {
            panel.style.display = 'block'; panel.style.borderColor = '#ff0000';
            title.innerHTML = `<span style="color:#ff0000">âš ï¸ ã€æ¥µé™½åè½‰è­¦å‘Šï¼š33333 çµæ§‹ã€‘</span>`;
            body.innerHTML = `å¤§é€±æœŸè™•æ–¼æ¥µç››ç‹€æ…‹ã€‚15M ä»¥ä¸‹è‹¥é—œé–€å³å¼•ç™¼å¤§è·Œã€‚`;
            let closedCount = 0; [5,6,7].forEach(i => { if (matrix[i].gateStatus === 'CLOSED') closedCount++; });
            counter.innerHTML = `å¾®è§€é–€é—œé–‰æ•¸ï¼š${closedCount} (æ•¸é‡è¶Šå¤šè¶Šå±éšª)`;
        } else if (isAllC) {
            panel.style.display = 'block'; panel.style.borderColor = 'var(--down-green)';
            title.innerHTML = `<span style="color:var(--down-green)">ğŸš€ ã€æ¥µé™°è½‰å¤šæç¤ºï¼šCCCCC çµæ§‹ã€‘</span>`;
            body.innerHTML = `å¸‚å ´è™•æ–¼æ¥µè² ä¹‹åœ°ã€‚å°‹æ‰¾ 15M åº•éƒ¨é–‹é–€çš„ç¬¬ä¸€æ‰³æ©Ÿã€‚`;
            let openCount = 0; [5,6,7].forEach(i => { if (matrix[i].gateStatus === 'OPEN') openCount++; });
            counter.innerHTML = `å¾®è§€é–€é–‹å•Ÿæ•¸ï¼š${openCount} (æ•¸é‡è¶Šå¤šè½‰å¼·ä¿¡è™Ÿè¶ŠçœŸ)`;
        } else { panel.style.display = 'none'; }
    }

    function getPowerLevel(p) {
        if (p >= 85) return {id:1, name:"1. æ¥µå¤š"};
        if (p >= 70) return {id:2, name:"2. å¼·å¤š"};
        if (p >= 50) return {id:3, name:"3. å¤šç©ºé—œéµ"};
        if (p >= 30) return {id:4, name:"4. ç©ºèª˜å¤š"};
        return {id:5, name:"5. ç©ºé ­"};
    }

    function getGateStatus(tag) {
        if (tag === 0 || tag === 2) return {txt:"ğŸ”“ é–‹é–€", cls:"gs-open"};
        if (tag === 1) return {txt:"ğŸ”„ æ¸¬é–€", cls:"gs-open"};
        if (tag === 4) return {txt:"âš ï¸ Båå½ˆæ‰¾ç©ºé»", cls:"gs-alert"};
        return {txt:"ğŸ”’ é—œé–€", cls:"gs-close"};
    }

    window.onload = initUI;
</script>

</body>
</html>